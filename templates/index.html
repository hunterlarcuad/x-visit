{% extends "base.html" %}

{% block content %}
<style>
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* 固定提示条样式 */
    .fixed-alerts {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1050;
        pointer-events: none;
    }
    
    .fixed-alerts .alert {
        pointer-events: auto;
        margin: 10px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    /* 为固定提示条留出空间 */
    .main-content {
        margin-bottom: 80px;
    }
</style>

<!-- 固定提示条区域 -->
<div class="fixed-alerts">
    <!-- 配置加载提示 -->
    <div id="config-loading-alert" class="alert alert-info alert-dismissible fade" style="display: none;">
        <i class="bi bi-info-circle"></i>
        <span id="config-loading-text"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <!-- 自动保存状态提示 -->
    <div id="auto-save-alert" class="alert alert-success alert-dismissible fade" style="display: none;">
        <i class="bi bi-check-circle"></i>
        <span id="auto-save-text">配置已自动保存</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<!-- 主要内容区域 -->
<div class="main-content">
    <!-- 配置管理部分 -->
    <div id="config-section" class="section">
        <div class="config-section">
            <!-- 操作按钮区域 - 左上角 -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-body p-3">
                            <div class="d-flex flex-wrap gap-2 justify-content-start">
                                <button type="button" class="btn btn-info" onclick="toggleCommand()">
                                    <i class="bi bi-terminal"></i> <span data-i18n="config.show_command">预览命令</span>
                                </button>
                                <button type="button" class="btn btn-success" onclick="startScript()">
                                    <i class="bi bi-play"></i> <span data-i18n="config.start_script">立即发射</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3><i class="bi bi-gear"></i> <span data-i18n="config.title">参数配置</span></h3>
            
            <form id="config-form">
                <div class="row">
                    <!-- 左侧参数 -->
                    <div class="col-12 col-lg-8">
                        <h5 data-i18n="config.core_params">核心参数</h5>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <label for="profile" class="form-label mb-0" data-i18n="config.profile">Profile (账号)</label>
                                <i class="bi bi-info-circle text-muted" 
                                   style="cursor: help; font-size: 14px;" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-i18n-title="config.profile_tooltip" title="从datas/account/x_account.csv加载的账号列表，支持多选，多个账号用逗号连接"></i>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="clearProfileSelection()" data-i18n-title="common.clear" title="清空选择">
                                    <span data-i18n="common.clear">清空</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllProfiles()">
                                    <i class="bi bi-check-all"></i> <span data-i18n="common.select_all">全选</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllProfiles()">
                                    <i class="bi bi-x-circle"></i> <span data-i18n="common.deselect_all">取消全选</span>
                                </button>
                            </div>
                            <select class="form-select" id="profile" name="profile" multiple>
                                <option value="" data-i18n="config.profile_placeholder">请选择账号...</option>
                            </select>

                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <label for="max_interactions" class="form-label me-2 mb-0" data-i18n="config.max_interactions">最大互动次数</label>
                                <i class="bi bi-info-circle text-muted me-2" 
                                   style="cursor: help; font-size: 14px;" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   data-i18n-title="config.max_interactions_tooltip" title="控制每个账号的互动轮数"></i>
                                <select class="form-select" id="max_interactions" name="max_interactions" style="width: 80px;">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="30">30</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="headless" name="headless">
                                    <label class="form-check-label" for="headless" id="headless-label" data-i18n="config.headless_unchecked">
                                        观察模式
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="force" name="force">
                                    <label class="form-check-label" for="force" id="force-label" data-i18n="config.force_unchecked">
                                        每日一次
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="water" name="water">
                                    <label class="form-check-label" for="water" data-i18n="config.water">
                                        灌水模式
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ad_user" name="ad_user">
                                    <label class="form-check-label" for="ad_user" data-i18n="config.ad_user">
                                        追星模式
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4">
                            <span data-i18n="config.vpn_params">VPN参数</span>
                            <i class="bi bi-info-circle text-muted ms-1" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               data-bs-html="true"
                               data-i18n-title="config.vpn_tooltip" title="<strong>自动切换VPN：</strong>依赖 Clash API，用于多个账号，按代理信息，自动切换 VPN<br><br><strong>跳过VPN设置：</strong>忽略VPN配置，使用当前的 VPN<br><br><strong>手动设置VPN：</strong>在执行前，提示设置VPN，设置后，在输入框输入确认信息，点击继续，才会执行，否则会一直等待<br><br><em>* 如果是单号，推荐使用 跳过VPN设置 模式。</em>"></i>
                        </h5>
                        <div class="mb-2">
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vpn_auto" name="vpn_auto">
                                    <label class="form-check-label" for="vpn_auto" data-i18n="config.vpn_auto">
                                        自动切换VPN
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="no_auto_vpn" name="no_auto_vpn">
                                    <label class="form-check-label" for="no_auto_vpn" data-i18n="config.vpn_skip">
                                        跳过VPN设置
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vpn_manual" name="vpn_manual">
                                    <label class="form-check-label" for="vpn_manual" data-i18n="config.vpn_manual">
                                        手动设置VPN
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4">
                            <i class="bi bi-puzzle"></i> <span data-i18n="config.extension_check">扩展检测</span>
                            <i class="bi bi-info-circle text-muted ms-1" 
                               data-bs-toggle="tooltip" 
                               data-i18n-title="config.extension_check_tooltip" title="检测浏览器扩展是否正确安装，确保脚本正常运行"></i>
                        </h5>
                        <div class="mb-2">
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="do_extension_check" name="do_extension_check">
                                    <label class="form-check-label" for="do_extension_check" data-i18n="config.enable_extension_check">
                                        启用扩展检测
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="extension-check-details" class="collapse">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="extension_check_max_try" class="form-label">
                                            <span data-i18n="config.extension_check_max_try">扩展检测最大重试次数</span>
                                            <i class="bi bi-info-circle text-muted ms-1" 
                                               data-bs-toggle="tooltip" 
                                               data-i18n-title="config.extension_check_max_try_tooltip" title="当扩展检测失败时，最多重试的次数"></i>
                                        </label>
                                        <input type="number" class="form-control" id="extension_check_max_try" name="extension_check_max_try" value="3" min="1" max="10" disabled>
                                        <div class="form-text" data-i18n="config.extension_check_max_try_help">检测扩展是否安装时的最大重试次数，建议设置为3-5次</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="extension_id" class="form-label">
                                            <span data-i18n="config.custom_extension_id">自定义扩展ID</span>
                                            <i class="bi bi-info-circle text-muted ms-1" 
                                               data-bs-toggle="tooltip" 
                                               data-i18n-title="config.custom_extension_id_tooltip" title="指定需要检测的浏览器扩展ID，多个用逗号分隔"></i>
                                        </label>
                                        <input type="text" class="form-control" id="extension_id" name="extension_id" data-i18n-placeholder="config.custom_extension_id_placeholder" placeholder="例如: abc123,def456" disabled>
                                        <div class="form-text" data-i18n="config.custom_extension_id_help">留空则使用默认扩展：okx, yescaptcha, capmonster</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4" data-i18n="config.loop_control">循环控制</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="loop_interval" class="form-label" data-i18n="config.loop_interval_label">循环间隔 (秒)</label>
                                    <input type="number" class="form-control" id="loop_interval" name="loop_interval" value="60">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sleep_sec_min" class="form-label" data-i18n="config.sleep_min_label">最小休眠时间 (秒)</label>
                                    <input type="number" class="form-control" id="sleep_sec_min" name="sleep_sec_min" value="3">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sleep_sec_max" class="form-label" data-i18n="config.sleep_max_label">最大休眠时间 (秒)</label>
                                    <input type="number" class="form-control" id="sleep_sec_max" name="sleep_sec_max" value="10">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧代理信息 -->
                    <div class="col-12 col-lg-4">
                        <h5 data-i18n="control.proxy_info">代理信息</h5>
                        
                        <!-- Proxy信息显示区域 -->
                        <div id="proxy-info" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong data-i18n="control.account_proxy">账号使用的代理:</strong> <span id="proxy-value"></span>
                            </div>
                        </div>
                        
                        <!-- 当前代理信息显示区域 -->
                        <div id="current-proxy-info" class="mb-3" style="display: none;">
                            <div class="alert alert-warning">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <i class="bi bi-globe"></i>
                                        <strong data-i18n="control.current_proxy">当前代理信息:</strong>
                                        <div class="mt-1">
                                            <span class="badge bg-primary me-2"><span data-i18n="control.country">国家</span>: <span id="current-country"></span></span>
                                            <span class="badge bg-secondary me-2"><span data-i18n="control.code">代码</span>: <span id="current-country-code"></span></span>
                                            <span class="badge bg-info"><span data-i18n="control.ip">IP</span>: <span id="current-ip"></span></span>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="getCurrentProxyInfo()">
                                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="common.refresh">刷新</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h5 data-i18n="config.other_options">其他选项</h5>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto_like" name="auto_like">
                                <label class="form-check-label" for="auto_like" data-i18n="config.auto_like">
                                    自动点赞
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto_appeal" name="auto_appeal">
                                <label class="form-check-label" for="auto_appeal" data-i18n="config.auto_appeal">
                                    自动申诉
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="manual_exit" name="manual_exit">
                                <label class="form-check-label" for="manual_exit" data-i18n="config.manual_exit">
                                    手动退出
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="create" name="create">
                                <label class="form-check-label" for="create" data-i18n="config.create">
                                    创建模式
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="reset" name="reset">
                                <label class="form-check-label" for="reset" data-i18n="config.reset">
                                    清理缓存
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
            </form>
            
            <!-- 执行命令显示区域 -->
            <div id="command-section" class="config-section" style="display: none;">
                <h4><i class="bi bi-terminal"></i> <span data-i18n="config.execute_command">执行命令</span></h4>
                <div class="alert alert-info">
                    <strong data-i18n="config.full_command">完整命令:</strong>
                    <div id="command-display" class="command-display">
                        请先配置参数，然后点击"预览命令"按钮
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong data-i18n="config.command_warning_title">注意:</strong> <span data-i18n="config.command_warning_text">此命令将在后台执行，您可以在"运行日志"页面查看执行结果。</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 控制面板部分 -->
    <div id="control-section" class="section" style="display: none;">
        <div class="config-section">
            
            <div class="row">
                <div class="col-md-6 d-flex">
                    <div class="card flex-fill">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <span data-i18n="control.script_status">发射状态</span>: 
                                <span class="badge bg-secondary ms-2" id="control-status" data-i18n="control.stopped">停止</span>
                            </h5>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-success" id="start-button" onclick="startScript()">
                                    <i class="bi bi-play"></i> <span data-i18n="control.start">启动</span>
                                </button>
                                <button type="button" class="btn btn-danger" id="stop-button" onclick="stopScript()">
                                    <i class="bi bi-stop"></i> <span data-i18n="control.stop">停止</span>
                                </button>
                                <button type="button" class="btn btn-warning" id="cleanup-btn" onclick="cleanupProcesses()" disabled>
                                    <i class="bi bi-trash"></i> <span data-i18n="control.cleanup_processes">清理进程</span> (<span id="chromium-count">0</span>)
                                </button>
                            </div>
                            
                            <!-- 运行时长显示区域 -->
                            <div id="runtime-section" class="mt-2" style="display: none;">
                                <div class="alert alert-info py-2">
                                    <i class="bi bi-clock"></i> 
                                    <strong data-i18n="control.runtime">运行时长:</strong> 
                                    <span id="runtime-display" class="fw-bold"></span>
                                </div>
                            </div>
                            
                            <!-- 当前运行信息显示区域 -->
                            <div id="running-info-section" class="mt-3" style="display: none;">
                                <div class="alert alert-success">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-play-circle"></i> <span data-i18n="control.current_running_info">当前运行信息</span>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong data-i18n="control.running_account">运行账号:</strong> <span id="running-account"></span></p>
                                            <p class="mb-1"><strong data-i18n="control.process_id">进程ID:</strong> <span id="process-pid"></span></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <p class="mb-1"><strong data-i18n="control.start_time">启动时间:</strong> <span id="start-time" style="white-space: nowrap;"></span></p>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="mb-1"><strong data-i18n="control.full_command">完整命令:</strong></p>
                                        <code id="full-command" class="small d-block"></code>
                                    </div>
                                    <div class="mt-2">
                                        <p class="mb-1"><strong data-i18n="control.parameters_description">参数说明:</strong></p>
                                        <div id="parameters-list" class="small"></div>
                                    </div>
                                </div>
                                

                            </div>
                            
                            <!-- 今日数据统计 - 独立区域 -->
                            <div id="today-stats-section" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-graph-up"></i> <span id="stats-title" data-i18n="control.today_stats">今日数据统计</span>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-primary mb-1" id="stats-follow">0</div>
                                                <small class="text-muted" data-i18n="control.follow">关注</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-success mb-1" id="stats-like">0</div>
                                                <small class="text-muted" data-i18n="control.like">点赞</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-warning mb-1" id="stats-reply">0</div>
                                                <small class="text-muted" data-i18n="control.reply">回复</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-info mb-1" id="stats-total">0</div>
                                                <small class="text-muted" data-i18n="control.total">总计</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-muted"><span data-i18n="control.update_time">更新时间:</span> <span id="stats-update-time"></span></small>
                                        <br>
                                        <small class="text-muted"><span data-i18n="control.next_refresh">下次刷新:</span> <span id="stats-countdown">5</span><span data-i18n="control.seconds">秒</span></small>
                                        <br>
                                        <button id="manual-refresh-stats" class="btn btn-sm btn-outline-primary mt-1" onclick="manualRefreshStats()" style="display: none;">
                                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="control.manual_refresh">手动刷新</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 等待输入提示 -->
                            <div id="waiting-input-alert" class="alert alert-info mt-3" style="display: none;">
                                <i class="bi bi-info-circle"></i>
                                <strong data-i18n="control.script_waiting">脚本正在等待输入</strong>
                                <p class="mb-0 mt-2" data-i18n="control.script_waiting_desc">脚本已启动并正在等待用户输入。请查看下方的输入区域或日志页面获取详细信息。</p>
                                <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="checkInputStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> <span data-i18n="control.recheck_status">重新检查状态</span>
                                </button>
                            </div>
                            
                            <!-- 脚本输入区域 -->
                            <div id="script-input-section" class="mt-3" style="display: none;">
                                <div class="alert alert-warning">
                                    <strong data-i18n="control.script_input">脚本等待输入:</strong>
                                    <div class="input-group mt-2">
                                        <input type="text" class="form-control" id="script-input" data-i18n-placeholder="control.input_placeholder" placeholder="请输入内容...">
                                        <button class="btn btn-primary" onclick="sendInput()">
                                            <i class="bi bi-arrow-right"></i> <span data-i18n="control.continue">继续</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 d-flex">
                    <div class="card flex-fill">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <i class="bi bi-play-circle"></i> <span data-i18n="control.run_log">Run.log (脚本运行日志)</span>
                            </h5>
                            <div class="log-container flex-grow-1" id="control-run-log-container" style="min-height: 300px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 12px;">
                                <div class="text-muted" data-i18n="control.waiting_log_output">等待run.log输出...</div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshControlRunLog()">
                                    <i class="bi bi-arrow-clockwise"></i> <span data-i18n="control.refresh_log">刷新日志</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearControlRunLog()">
                                    <i class="bi bi-trash"></i> <span data-i18n="control.clear_log">清空日志</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志部分 -->
    <div id="logs-section" class="section" style="display: none;">
        <div class="config-section">
            <h3><i class="bi bi-terminal"></i> <span data-i18n="logs.title">运行日志</span></h3>
            
            <div class="mb-3">
                <div class="row">
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap gap-2 mb-2 mb-md-0">
                            <button type="button" class="btn btn-secondary" onclick="refreshAllLogs()">
                                <i class="bi bi-arrow-clockwise"></i> <span data-i18n="logs.refresh_logs">刷新日志</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearAllLogs()">
                                <i class="bi bi-trash"></i> <span data-i18n="logs.clear_logs">清空日志</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap align-items-center justify-content-start justify-content-md-end gap-2">
                            <label for="refresh-interval" class="form-label mb-0" data-i18n="logs.refresh_interval">刷新间隔:</label>
                            <select class="form-select" id="refresh-interval" style="width: auto; min-width: 100px;">
                                <option value="3000" data-i18n="logs.refresh_interval_3s">3秒</option>
                                <option value="5000" data-i18n="logs.refresh_interval_5s">5秒</option>
                                <option value="10000" data-i18n="logs.refresh_interval_10s">10秒</option>
                                <option value="30000" data-i18n="logs.refresh_interval_30s">30秒</option>
                                <option value="0" selected data-i18n="logs.refresh_interval_off">不刷新</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 日志页面等待输入提示 -->
            <div id="logs-waiting-input-alert" class="alert alert-info mb-3" style="display: none;">
                <i class="bi bi-info-circle"></i>
                <strong data-i18n="logs.script_waiting_input">脚本正在等待输入</strong>
                <p class="mb-0 mt-2" data-i18n="logs.script_waiting_input_desc">脚本已启动并正在等待用户输入。请切换到"控制面板"页面进行输入操作。</p>
            </div>
            
            <!-- Server.log 区域 -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-server"></i> <span data-i18n="logs.server_log">Server.log (Flask应用日志)</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="log-container" id="server-log-container" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 12px;">
                        <div class="text-muted" data-i18n="logs.waiting_server_log">等待server.log输出...</div>
                    </div>
                </div>
            </div>
            
            <!-- Run.log 区域 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-play-circle"></i> <span data-i18n="logs.run_log">Run.log (脚本运行日志)</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="log-container" id="run-log-container" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 12px;">
                        <div class="text-muted" data-i18n="logs.waiting_run_log">等待run.log输出...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 账号状态部分 -->
    <div id="status-section" class="section" style="display: none;">
        <div class="config-section">
            <h3><i class="bi bi-person-check"></i> <span data-i18n="status.title">账号状态</span></h3>
            
            <!-- 筛选和操作区域 -->
            <div class="row mb-3">
                <div class="col-12 col-md-6">
                    <div class="d-flex flex-wrap gap-2">
                        <input type="text" class="form-control" id="status-filter" data-i18n-placeholder="status.search_placeholder" placeholder="搜索账号或代理..." style="min-width: 200px;">
                        <select class="form-select" id="status-filter-select" style="min-width: 120px;">
                            <option value="" data-i18n="status.all_status">全部状态</option>
                            <option value="OK" data-i18n="status.normal">正常</option>
                            <option value="ERROR" data-i18n="status.error">异常</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="refreshAccountStatus()">
                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="status.refresh">刷新</span>
                        </button>
                    </div>
                </div>
                                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap gap-2 justify-content-start justify-content-md-end">
                            <button type="button" class="btn btn-info" onclick="showSelectedCommand()">
                                <i class="bi bi-terminal"></i> <span data-i18n="status.show_command">显示命令</span>
                            </button>
                            <button type="button" class="btn btn-success" onclick="startSelectedAccounts()">
                                <i class="bi bi-play"></i> <span data-i18n="status.start_selected">启动选中账号</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="selectAllAccounts()">
                                <i class="bi bi-check-all"></i> <span data-i18n="status.select_all">全选</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="deselectAllAccounts()">
                                <i class="bi bi-x-circle"></i> <span data-i18n="status.deselect_all">取消全选</span>
                            </button>
                        </div>
                    </div>
            </div>
            
            <!-- 账号状态表格 -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()">
                            </th>
                            <th class="sortable" onclick="sortTable('account')" style="cursor: pointer;">
                                <span data-i18n="status.account">账号</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('status')" style="cursor: pointer;">
                                <span data-i18n="status.status">状态</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('update_time')" style="cursor: pointer;">
                                <span data-i18n="status.update_time">更新时间</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('days_ago')" style="cursor: pointer;">
                                <span data-i18n="status.days_ago">更新天数</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('visit_date')" style="cursor: pointer;">
                                <span data-i18n="status.visit_date">访问日期</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('num_visit')" style="cursor: pointer;">
                                <span data-i18n="status.num_visit">访问次数</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th class="sortable" onclick="sortTable('proxy')" style="cursor: pointer;">
                                <span data-i18n="status.proxy">代理</span> <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th data-i18n="status.actions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="status-table-body">
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> <span data-i18n="status.loading">加载中...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 统计信息 -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-3">
                                <strong data-i18n="status.total_accounts">总账号数:</strong> <span id="total-accounts">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong data-i18n="status.normal_accounts">正常账号:</strong> <span id="ok-accounts">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong data-i18n="status.selected_accounts">选中账号:</strong> <span id="selected-accounts">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong data-i18n="status.last_update">最近更新:</strong> <span id="last-update">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 账号管理部分 -->
    <div id="accounts-section" class="section" style="display: none;">
        <div class="config-section">
            <h3><i class="bi bi-people"></i> <span data-i18n="accounts.title">账号管理</span></h3>
            
            <!-- 搜索和操作区域 -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="accounts-search" data-i18n-placeholder="accounts.search_placeholder" placeholder="搜索账号、用户名或代理..." onkeyup="searchAccounts()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="bi bi-x-circle"></i> <span data-i18n="accounts.clear">清除</span>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                            <i class="bi bi-plus-circle"></i> <span data-i18n="accounts.add_account">添加账号</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="refreshAccountsList()">
                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="accounts.refresh">刷新</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 搜索统计信息 -->
            <div class="row mb-3" id="search-stats" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-search"></i> <span data-i18n="accounts.search_results">搜索结果:</span> <span id="search-results-count">0</span> <span data-i18n="accounts.accounts_count">个账号</span>
                    </div>
                </div>
            </div>
            
                            <!-- 账号列表表格 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th data-i18n="accounts.account_name">账号名</th>
                                <th data-i18n="accounts.username">用户名</th>
                                <th data-i18n="accounts.password">密码</th>
                                <th data-i18n="accounts.verification_code">验证码</th>
                                <th data-i18n="accounts.proxy">代理</th>
                                <th width="150" data-i18n="accounts.actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> <span data-i18n="accounts.loading">加载中...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        </div>
    </div>

    <!-- 打赏作者部分 -->
    <div id="donation-section" class="section" style="display: none;">
        <div class="config-section">
            <h3><i class="bi bi-heart-fill"></i> <span data-i18n="donation.title">打赏作者</span></h3>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> <span data-i18n="donation.about_project">关于本项目</span></h5>
                        <p data-i18n-html="donation.project_description"><strong>XWool Personal Assistant</strong> 是一个薅羊毛个人助手，在大模型时代，AI已经渗透到日常生活的方方面面，打理 X 账号费时费力，让大模型来帮忙，我们可以喝着咖啡，有兴趣就看着他干活儿，没时间就让他自己在幕后跑着，跟粉丝做做互动。</p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h5><i class="bi bi-heart-fill text-danger"></i> <span data-i18n="donation.support_message">如果本项目对您有所帮助，不妨打赏一下，请我喝杯咖啡</span></h5>
                        <p class="mb-0" data-i18n="donation.support_description">您的支持是我继续开发和维护这个项目的动力！</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-qr-code"></i> <span data-i18n="donation.wechat_qr">微信收款码</span></h5>
                        </div>
                        <div class="card-body text-center">
                            <img src="/static/img/wechatpay.png" alt="微信收款码" class="img-fluid" style="max-width: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <p class="mt-3 text-muted" data-i18n="donation.scan_support">扫码支持作者，感谢您的慷慨！</p>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-currency-bitcoin"></i> <span data-i18n="donation.crypto_address">加密货币地址</span></h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-ethereum text-primary"></i> <span data-i18n="donation.ethereum_bsc">Ethereum / BSC</span></h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-monospace" value="0x38b45B70577C3923f49dB5BbAB9aD1141e3e216C" readonly id="eth-address">
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('eth-address')" data-i18n-title="donation.copy_address" title="复制地址">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted" data-i18n="donation.supported_tokens">支持 ETH、USDT、USDC 等 ERC-20 代币</small>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <div class="alert alert-info mb-0">
                                            <i class="bi bi-info-circle"></i>
                                            <strong data-i18n="donation.crypto_tip">温馨提示：</strong><br>
                                            <span data-i18n="donation.crypto_tip">请确保网络选择正确</span><br>
                                            <small data-i18n="donation.crypto_networks">Ethereum 主网 / BSC 智能链</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-shield-check"></i> <span data-i18n="donation.terms">使用条款</span></h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <span data-i18n="donation.terms_1">XWool Personal Assistant 仅用于辅助个人 X 账号互动</span></li>
                                <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> <span data-i18n="donation.terms_2">禁止将 XWool Personal Assistant 用于攻击与骚扰行为</span></li>
                                <li class="mb-2"><i class="bi bi-exclamation-triangle text-warning"></i> <span data-i18n="donation.terms_3">使用 XWool Personal Assistant 发生的一切行为均由使用人自行负责</span></li>
                                <li class="mb-2"><i class="bi bi-info-circle text-info"></i> <span data-i18n="donation.terms_4">因使用 XWool Personal Assistant 导致的 X 账号限流、被封，版权持有人不承担任何责任</span></li>
                                <li class="mb-0"><i class="bi bi-info-circle text-info"></i> <span data-i18n="donation.terms_5">版权持有人不对 XWool Personal Assistant 可能存在的缺陷导致的任何损失负任何责任</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-github"></i> <span data-i18n="donation.project_info">项目信息</span></h5>
                        </div>
                        <div class="card-body">
                            <p><strong data-i18n="donation.project_name">项目名称：</strong><br>XWool Personal Assistant</p>
                            <p><strong data-i18n="donation.project_type">项目类型：</strong><br><span data-i18n="donation.project_type_value">X 账号自动化管理工具</span></p>
                            <p><strong data-i18n="donation.github_url">GitHub 地址：</strong></p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control font-monospace" value="https://github.com/hunterlarcuad/x-visit" readonly id="github-url">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('github-url')" data-i18n-title="donation.copy_address" title="复制GitHub地址">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                                <a href="https://github.com/hunterlarcuad/x-visit" target="_blank" class="btn btn-primary" data-i18n-title="donation.open_github" title="在GitHub中打开">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                            <p><strong data-i18n="donation.main_features">主要功能：</strong></p>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-arrow-right"></i> <span data-i18n="donation.feature_1">自动互动（点赞、关注、转发、回复）</span></li>
                                <li><i class="bi bi-arrow-right"></i> <span data-i18n="donation.feature_2">多账号管理</span></li>
                                <li><i class="bi bi-arrow-right"></i> <span data-i18n="donation.feature_3">智能代理切换</span></li>
                                <li><i class="bi bi-arrow-right"></i> <span data-i18n="donation.feature_4">数据统计分析</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加账号模态框 -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newAccountName" class="form-label">账号名 *</label>
                                <input type="text" class="form-control" id="newAccountName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newAccountUsername" class="form-label">用户名 *</label>
                                <input type="text" class="form-control" id="newAccountUsername" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newAccountPassword" class="form-label">密码</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="newAccountPassword">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleNewPassword()">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newAccountVerifyCode" class="form-label">验证码</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="newAccountVerifyCode">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleNewVerifyCode()">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newAccountProxy" class="form-label">代理</label>
                        <input type="text" class="form-control" id="newAccountProxy" data-i18n-placeholder="config.proxy_placeholder" placeholder="例如: gcp-g01-tw">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addAccount()">添加账号</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑账号模态框 -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" id="editAccountOriginal">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountName" class="form-label">账号名 *</label>
                                <input type="text" class="form-control" id="editAccountName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountUsername" class="form-label">用户名 *</label>
                                <input type="text" class="form-control" id="editAccountUsername" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountPassword" class="form-label">密码</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editAccountPassword">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleEditPassword()">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountVerifyCode" class="form-label">验证码</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editAccountVerifyCode">
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleEditVerifyCode()">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAccountProxy" class="form-label">代理</label>
                        <input type="text" class="form-control" id="editAccountProxy" data-i18n-placeholder="config.proxy_placeholder" placeholder="例如: gcp-g01-tw">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateAccount()">保存更改</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除账号 <strong id="deleteAccountName"></strong> 吗？</p>
                <p class="text-danger">此操作不可撤销！</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">确认删除</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentConfig = {};
let logInterval = null;

// 全局变量
let commandSectionVisible = false;
let autoSaveTimer = null; // 自动保存定时器

// 显示提示消息
function showAlert(message, type = 'info') {
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" style="display: none;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 添加到固定提示条区域
    const fixedAlerts = document.querySelector('.fixed-alerts');
    fixedAlerts.insertAdjacentHTML('beforeend', alertHtml);
    
    // 显示提示
    const alert = document.getElementById(alertId);
    alert.style.display = 'block';
    alert.classList.add('show');
    
    // 3秒后自动隐藏
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 150);
    }, 3000);
}

// 复制到剪贴板功能
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.select();
        element.setSelectionRange(0, 99999); // 对于移动设备
        
        try {
            document.execCommand('copy');
            showAlert(getTranslation('donation.copy_success'), 'success');
        } catch (err) {
            // 如果execCommand失败，尝试使用现代的Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(element.value).then(() => {
                    showAlert(getTranslation('donation.copy_success'), 'success');
                }).catch(() => {
                    showAlert(getTranslation('donation.copy_failed'), 'danger');
                });
            } else {
                showAlert(getTranslation('donation.copy_failed'), 'danger');
            }
        }
    }
}

// 账号状态相关变量
let accountStatusData = [];
let filteredStatusData = [];
let currentSortColumn = 'update_time'; // 默认按更新时间排序
let currentSortDirection = 'asc'; // 默认正序排序

// 应用默认排序（按更新时间正序）
function applyDefaultSort() {
    currentSortColumn = 'update_time';
    currentSortDirection = 'asc';
    
    // 排序数据
    filteredStatusData.sort((a, b) => {
        let aValue = a.update_time;
        let bValue = b.update_time;
        
        // 时间排序
        aValue = aValue && aValue !== 'None' ? new Date(aValue) : new Date(0);
        bValue = bValue && bValue !== 'None' ? new Date(bValue) : new Date(0);
        
        // 正序排序（时间早的在前面）
        if (aValue < bValue) {
            return -1;
        } else if (aValue > bValue) {
            return 1;
        } else {
            return 0;
        }
    });
    
    // 更新表头图标
    updateSortIcons();
}

// 加载账号状态
function loadAccountStatus() {
    fetch('/api/account-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            accountStatusData = data.status_data;
            filteredStatusData = [...accountStatusData];
            
            // 应用默认排序（按更新时间正序）
            applyDefaultSort();
            
            renderAccountStatusTable();
            updateStatusStatistics();
        } else {
            showAlert('加载账号状态失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('加载账号状态失败: ' + error.message, 'danger');
    });
}

// 渲染账号状态表格
function renderAccountStatusTable() {
    const tbody = document.getElementById('status-table-body');
    tbody.innerHTML = '';
    
    if (filteredStatusData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <i class="bi bi-inbox"></i> 没有找到匹配的账号
                </td>
            </tr>
        `;
        return;
    }
    
    filteredStatusData.forEach((account, index) => {
        const row = document.createElement('tr');
        const statusClass = account.status === 'OK' ? 'text-success' : 
                          account.status === 'ERROR' ? 'text-danger' : 'text-warning';
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="account-checkbox" value="${account.account}" onchange="updateSelectedCount()">
            </td>
            <td><strong>${account.account}</strong></td>
            <td><span class="${statusClass}">${account.status}</span></td>
            <td>${account.update_time || '-'}</td>
            <td><span class="text-muted">${account.days_ago}</span></td>
            <td>${account.visit_date || '-'}</td>
            <td>${account.num_visit || '0'}</td>
            <td><span class="text-info">${account.proxy || '-'}</span></td>
            <td>
                <button type="button" class="btn btn-sm btn-success" onclick="startSingleAccount('${account.account}')">
                    <i class="bi bi-play"></i> 启动
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 更新统计信息
function updateStatusStatistics() {
    const total = accountStatusData.length;
    const okCount = accountStatusData.filter(a => a.status === 'OK').length;
    const selectedCount = document.querySelectorAll('.account-checkbox:checked').length;
    
    // 找到最近更新的账号
    let lastUpdate = '-';
    if (accountStatusData.length > 0) {
        const sorted = [...accountStatusData].sort((a, b) => {
            if (!a.update_time || a.update_time === 'None') return 1;
            if (!b.update_time || b.update_time === 'None') return -1;
            return new Date(b.update_time) - new Date(a.update_time);
        });
        if (sorted[0].update_time && sorted[0].update_time !== 'None') {
            lastUpdate = sorted[0].days_ago;
        }
    }
    
    document.getElementById('total-accounts').textContent = total;
    document.getElementById('ok-accounts').textContent = okCount;
    document.getElementById('selected-accounts').textContent = selectedCount;
    document.getElementById('last-update').textContent = lastUpdate;
}

// 筛选账号
function filterAccounts() {
    const searchTerm = document.getElementById('status-filter').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter-select').value;
    
    filteredStatusData = accountStatusData.filter(account => {
        const matchesSearch = account.account.toLowerCase().includes(searchTerm) ||
                             (account.proxy && account.proxy.toLowerCase().includes(searchTerm));
        
        let matchesStatus = true;
        if (statusFilter) {
            if (statusFilter === 'ERROR') {
                // 异常选项同时筛选ERROR和SUSPEND状态
                matchesStatus = account.status === 'ERROR' || account.status === 'SUSPEND';
            } else {
                matchesStatus = account.status === statusFilter;
            }
        }
        
        return matchesSearch && matchesStatus;
    });
    
    // 如果当前有排序，重新应用排序
    if (currentSortColumn) {
        sortTable(currentSortColumn);
    } else {
        renderAccountStatusTable();
    }
    
    updateStatusStatistics();
}

// 刷新账号状态
function refreshAccountStatus() {
    // 重置排序状态为默认排序
    currentSortColumn = 'update_time';
    currentSortDirection = 'asc';
    
    loadAccountStatus();
}

// 检查脚本输入状态
function checkInputStatus() {
    fetch('/api/script/input-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const waitingForInput = data.waiting_for_input;
                const lastLine = data.last_line;
                const debugInfo = data.debug_info;
                
                // 只在状态变化时记录调试日志
                if (window.lastInputStatus !== waitingForInput) {
                    console.log('输入状态变化:', {
                        from: window.lastInputStatus,
                        to: waitingForInput,
                        lastLine: lastLine
                    });
                    window.lastInputStatus = waitingForInput;
                }
                
                const waitingAlert = document.getElementById('waiting-input-alert');
                const inputSection = document.getElementById('script-input-section');
                const logsWaitingAlert = document.getElementById('logs-waiting-input-alert');
                
                if (waitingForInput) {
                    // 显示输入区域
                    if (waitingAlert) waitingAlert.style.display = 'block';
                    if (inputSection) inputSection.style.display = 'block';
                    if (logsWaitingAlert) logsWaitingAlert.style.display = 'block';
                } else {
                    // 隐藏输入区域
                    if (waitingAlert) waitingAlert.style.display = 'none';
                    if (inputSection) inputSection.style.display = 'none';
                    if (logsWaitingAlert) logsWaitingAlert.style.display = 'none';
                }
            } else {
                console.error('检查输入状态失败:', data.message);
            }
        })
        .catch(error => {
            console.error('检查输入状态失败:', error);
        });
}

// 定期检查输入状态
function startInputStatusCheck() {
    // 立即检查一次
    checkInputStatus();
    
    // 每5秒检查一次
    setInterval(() => {
        checkInputStatus();
        // 如果当前在控制面板，同时刷新run.log
        const controlSection = document.getElementById('control-section');
        if (controlSection && controlSection.style.display !== 'none') {
            refreshControlRunLog();
        }
    }, 5000);
}

// 启动单个账号
function startSingleAccount(account) {
    // 设置账号到配置表单
    const profileSelect = document.getElementById('profile');
    if (profileSelect) {
        // 先清空所有选择
        profileSelect.value = '';
        // 如果是Select2，需要更新
        if ($('#profile').hasClass('select2-hidden-accessible')) {
            $('#profile').val([]).trigger('change');
        }
        
        // 然后设置新的账号
        profileSelect.value = account;
        // 如果是Select2，需要更新
        if ($('#profile').hasClass('select2-hidden-accessible')) {
            $('#profile').val([account]).trigger('change');
        }
        
        // Select2的trigger('change')已经会触发事件，无需额外触发
        
        // 设置标记，防止loadAccounts重新初始化时覆盖
        profileSelect.setAttribute('data-manually-set', 'true');
        profileSelect.setAttribute('data-manual-account', account);
    }
    
    // 切换到配置管理页面
    showSection('config');
    showAlert(`已选择账号: ${account}，请在配置管理页面启动`, 'info');
}

// 显示选中账号的命令
function showSelectedCommand() {
    const selectedAccounts = Array.from(document.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedAccounts.length === 0) {
        showAlert('请先选择要查看命令的账号', 'warning');
        return;
    }
    
    if (selectedAccounts.length === 1) {
        // 单个账号，显示详细命令
        const account = selectedAccounts[0];
        showSingleAccountCommand(account);
    } else {
        // 多个账号，显示批量命令预览
        showMultipleAccountsCommand(selectedAccounts);
    }
}

// 显示单个账号的命令
function showSingleAccountCommand(account) {
    // 不跳转页面，直接在当前页面显示命令
    
    // 获取当前配置表单的值
    getCurrentConfig().then(config => {
        // 设置账号到配置中
        config.profile = account;
        
        // 生成命令
        const cmd = generateCommandFromConfig(config);
        
        // 在账号状态页面显示命令
        showCommandInStatusPage(cmd, account);
    });
}

// 获取当前配置
function getCurrentConfig() {
    const config = {};
    
    // 获取Profile值（从配置管理页面）
    const profileSelect = document.getElementById('profile');
    if (profileSelect && profileSelect.value) {
        config.profile = profileSelect.value;
    }
    
    // 获取其他配置项
    const form = document.getElementById('config-form');
    if (form) {
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
            if (value !== '') {
                config[key] = value;
            }
        }
        
        // 处理复选框
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            config[checkbox.name] = checkbox.checked;
        });
        
        // 处理数字输入框
        const numberInputs = form.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            if (input.value !== '') {
                config[input.name] = input.value;
            }
        });
        
        // 处理文本输入框
        const textInputs = form.querySelectorAll('input[type="text"]');
        textInputs.forEach(input => {
            if (input.value !== '') {
                config[input.name] = input.value;
            }
        });
    }
    
    // 如果配置为空或只有profile，从auto_saved_config获取配置
    if (Object.keys(config).length <= 1) {
        console.log('配置管理页面未加载，从auto_saved_config获取配置');
        return loadAutoSavedConfig();
    }
    
    console.log('获取到的配置:', config);
    return config;
}

// 从auto_saved_config加载配置
function loadAutoSavedConfig() {
    return fetch('/api/config/last-used')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                console.log('从last_used_config加载的配置:', data.config);
                return data.config;
            } else {
                console.log('last_used_config加载失败，使用默认配置');
                return getDefaultConfig();
            }
        })
        .catch(error => {
            console.error('加载last_used_config失败:', error);
            return getDefaultConfig();
        });
}

// 获取默认配置
function getDefaultConfig() {
    return {
        headless: true,
        force: false,
        water: false,
        ad_user: false,
        vpn_auto: false,
        no_auto_vpn: true,  // 默认跳过VPN设置
        vpn_manual: false,
        auto_like: false,
        auto_appeal: false,
        manual_exit: false,
        create: false,
        reset: false,
        max_interactions: '10',
        loop_count: '1',
        loop_interval: '60',
        sleep_sec_min: '3',
        sleep_sec_max: '10'
    };
}

// 从配置生成命令
function generateCommandFromConfig(config) {
    console.log('生成命令的配置:', config);
    
    let cmd = 'python xwool.py';
    
    // 添加参数
    for (let [key, value] of Object.entries(config)) {
        if (value !== null && value !== '' && value !== false) {
            if (typeof value === 'boolean' && value === true) {
                cmd += ` --${key}`;
            } else {
                cmd += ` --${key} ${value}`;
            }
        }
    }
    
    console.log('生成的命令:', cmd);
    return cmd;
}

// 在账号状态页面显示命令
function showCommandInStatusPage(cmd, account) {
    // 创建或获取命令显示区域
    let commandDisplay = document.getElementById('status-command-display');
    if (!commandDisplay) {
        commandDisplay = document.createElement('div');
        commandDisplay.id = 'status-command-display';
        commandDisplay.className = 'mt-3 p-3 bg-light border rounded';
        commandDisplay.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="bi bi-terminal"></i> <span data-i18n="config.execute_command">执行命令</span></h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeStatusCommand()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="mb-2">
                <small class="text-muted">账号: <strong>${account}</strong></small>
            </div>
            <div class="bg-dark text-light p-2 rounded font-monospace" style="font-size: 0.9em; word-break: break-all;">
                ${cmd}
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-primary" onclick="copyStatusCommand()">
                    <i class="bi bi-clipboard"></i> <span data-i18n="common.copy">复制命令</span>
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="startStatusCommand('${account}')">
                    <i class="bi bi-play"></i> <span data-i18n="config.start_script">启动脚本</span>
                </button>
            </div>
        `;
        
        // 插入到账号状态表格后面
        const statusSection = document.getElementById('status-section');
        const table = statusSection.querySelector('.table-responsive');
        table.parentNode.insertBefore(commandDisplay, table.nextSibling);
    } else {
        // 更新现有命令显示
        commandDisplay.querySelector('.text-muted strong').textContent = account;
        commandDisplay.querySelector('.font-monospace').textContent = cmd;
        commandDisplay.style.display = 'block';
    }
    
    // 滚动到命令显示区域
    commandDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // 重新应用翻译到新创建的元素
    applyTranslations();
    
    showAlert(`已生成账号 ${account} 的执行命令`, 'info');
}

// 关闭状态页面的命令显示
function closeStatusCommand() {
    const commandDisplay = document.getElementById('status-command-display');
    if (commandDisplay) {
        commandDisplay.style.display = 'none';
    }
}

// 复制状态页面的命令
function copyStatusCommand() {
    const commandText = document.querySelector('#status-command-display .font-monospace').textContent;
    navigator.clipboard.writeText(commandText).then(() => {
        showAlert('命令已复制到剪贴板', 'success');
    }).catch(() => {
        showAlert('复制失败，请手动复制', 'warning');
    });
}

// 启动状态页面的命令
function startStatusCommand(account) {
    // 跳转到配置管理页面并启动脚本
    showSection('config');
    
    // 设置账号到配置表单
    const profileSelect = document.getElementById('profile');
    if (profileSelect) {
        // 先清空所有选择
        profileSelect.value = '';
        // 如果是Select2，需要更新
        if ($('#profile').hasClass('select2-hidden-accessible')) {
            $('#profile').val([]).trigger('change');
        }
        
        // 然后设置新的账号
        profileSelect.value = account;
        // 如果是Select2，需要更新
        if ($('#profile').hasClass('select2-hidden-accessible')) {
            $('#profile').val([account]).trigger('change');
        }
        
        // Select2的trigger('change')已经会触发事件，无需额外触发
        
        // 设置标记，防止loadAccounts重新初始化时覆盖
        profileSelect.setAttribute('data-manually-set', 'true');
        profileSelect.setAttribute('data-manual-account', account);
    }
    
    // 启动脚本
    setTimeout(() => {
        startScript();
    }, 200);
}

// ==================== 账号管理功能 ====================

// 全局变量
let accountsData = [];
let accountToDelete = null;
let filteredAccountsData = [];
let isSearching = false;

// 加载账号列表
function loadAccountsList() {
    console.log('开始加载账号列表...');
    fetch('/api/accounts/manage')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('账号列表加载成功，账号数量:', data.accounts.length);
                accountsData = data.accounts;
                
                // 如果当前在搜索状态，重新执行搜索以更新filteredAccountsData
                if (isSearching) {
                    console.log('当前在搜索状态，重新执行搜索...');
                    searchAccounts();
                } else {
                    renderAccountsTable();
                }
                
                showAlert('账号列表刷新成功', 'success');
            } else {
                console.error('加载账号列表失败:', data.error);
                showAlert('加载账号列表失败: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('加载账号列表失败:', error);
            showAlert('加载账号列表失败', 'error');
        });
}

// 渲染账号表格
function renderAccountsTable() {
    const tbody = document.getElementById('accounts-table-body');
    const dataToRender = isSearching ? filteredAccountsData : accountsData;
    
    if (dataToRender.length === 0) {
        const message = isSearching ? '没有找到匹配的账号' : '暂无账号数据';
        const icon = isSearching ? 'bi-search' : 'bi-inbox';
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="bi ${icon}"></i> ${message}
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = dataToRender.map(account => `
        <tr>
            <td><strong>${account.account}</strong></td>
            <td>${account.x_username || '-'}</td>
            <td>
                <span class="password-field" data-account="${account.account}" data-password="${account.x_pwd || ''}">***</span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="togglePassword('${account.account}')">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
            <td>
                <span class="verifycode-field" data-account="${account.account}" data-verifycode="${account.x_verifycode || ''}">***</span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="toggleVerifyCode('${account.account}')">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
            <td>${account.proxy || '-'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="editAccount('${account.account}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteAccount('${account.account}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}



// 显示添加账号模态框
function showAddAccountModal() {
    document.getElementById('newAccountName').value = '';
    document.getElementById('newAccountUsername').value = '';
    document.getElementById('newAccountPassword').value = '';
    document.getElementById('newAccountVerifyCode').value = '';
    document.getElementById('newAccountProxy').value = '';
    const modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
    modal.show();
}

// 添加账号
function addAccount() {
    const accountName = document.getElementById('newAccountName').value.trim();
    const username = document.getElementById('newAccountUsername').value.trim();
    const password = document.getElementById('newAccountPassword').value.trim();
    const verifyCode = document.getElementById('newAccountVerifyCode').value.trim();
    const proxy = document.getElementById('newAccountProxy').value.trim();
    
    if (!accountName) {
        showAlert('请输入账号名', 'warning');
        return;
    }
    
    if (!username) {
        showAlert('请输入用户名', 'warning');
        return;
    }
    
    fetch('/api/accounts/manage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            account: accountName,
            x_username: username,
            x_pwd: password,
            x_verifycode: verifyCode,
            proxy: proxy
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            
            // 先关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
            modal.hide();
            
            // 延迟刷新，确保模态框完全关闭后再刷新数据
            setTimeout(() => {
                loadAccountsList();
                loadAccounts(); // 刷新配置页面的账号下拉列表
                
                // 如果当前在搜索状态，重新执行搜索
                if (isSearching) {
                    searchAccounts();
                }
            }, 300);
        } else {
            showAlert('添加账号失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('添加账号失败:', error);
        showAlert('添加账号失败', 'error');
    });
}

// 编辑账号
function editAccount(accountName) {
    // 在搜索状态和正常状态中查找账号
    const account = (isSearching ? filteredAccountsData : accountsData).find(acc => acc.account === accountName);
    if (!account) {
        showAlert('账号不存在', 'error');
        return;
    }
    
    document.getElementById('editAccountOriginal').value = accountName;
    document.getElementById('editAccountName').value = account.account;
    document.getElementById('editAccountUsername').value = account.x_username || '';
    document.getElementById('editAccountPassword').value = account.x_pwd || '';
    document.getElementById('editAccountVerifyCode').value = account.x_verifycode || '';
    document.getElementById('editAccountProxy').value = account.proxy || '';
    
    // 重置密码和验证码字段的显示状态
    const passwordInput = document.getElementById('editAccountPassword');
    const verifycodeInput = document.getElementById('editAccountVerifyCode');
    const passwordButton = passwordInput.parentElement.querySelector('button');
    const verifycodeButton = verifycodeInput.parentElement.querySelector('button');
    
    // 设置密码字段为password类型
    passwordInput.type = 'password';
    passwordButton.querySelector('i').className = 'bi bi-eye';
    passwordButton.classList.remove('btn-outline-warning');
    passwordButton.classList.add('btn-outline-secondary');
    
    // 设置验证码字段为text类型（因为验证码通常不需要隐藏）
    verifycodeInput.type = 'text';
    verifycodeButton.querySelector('i').className = 'bi bi-eye';
    verifycodeButton.classList.remove('btn-outline-warning');
    verifycodeButton.classList.add('btn-outline-secondary');
    
    const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    modal.show();
}

// 更新账号
function updateAccount() {
    const originalAccount = document.getElementById('editAccountOriginal').value;
    const newAccountName = document.getElementById('editAccountName').value.trim();
    const username = document.getElementById('editAccountUsername').value.trim();
    const password = document.getElementById('editAccountPassword').value.trim();
    const verifyCode = document.getElementById('editAccountVerifyCode').value.trim();
    const proxy = document.getElementById('editAccountProxy').value.trim();
    
    if (!newAccountName) {
        showAlert('请输入账号名', 'warning');
        return;
    }
    
    if (!username) {
        showAlert('请输入用户名', 'warning');
        return;
    }
    
    fetch(`/api/accounts/manage/${encodeURIComponent(originalAccount)}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            account: newAccountName,
            x_username: username,
            x_pwd: password,
            x_verifycode: verifyCode,
            proxy: proxy
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            
            // 先关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
            modal.hide();
            
            // 延迟刷新，确保模态框完全关闭后再刷新数据
            setTimeout(() => {
                loadAccountsList();
                loadAccounts(); // 刷新配置页面的账号下拉列表
                
                // 如果当前在搜索状态，重新执行搜索
                if (isSearching) {
                    searchAccounts();
                }
            }, 300);
        } else {
            showAlert('更新账号失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('更新账号失败:', error);
        showAlert('更新账号失败', 'error');
    });
}

// 删除账号
function deleteAccount(accountName) {
    accountToDelete = accountName;
    document.getElementById('deleteAccountName').textContent = accountName;
    const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
    modal.show();
}

// 确认删除账号
function confirmDeleteAccount() {
    if (!accountToDelete) {
        showAlert('删除失败: 账号信息丢失', 'error');
        return;
    }
    
    fetch(`/api/accounts/manage/${encodeURIComponent(accountToDelete)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            
            // 先关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal'));
            modal.hide();
            
            // 延迟刷新，确保模态框完全关闭后再刷新数据
            setTimeout(() => {
                loadAccountsList();
                loadAccounts(); // 刷新配置页面的账号下拉列表
                
                // 如果当前在搜索状态，重新执行搜索
                if (isSearching) {
                    searchAccounts();
                }
            }, 300);
        } else {
            showAlert('删除账号失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('删除账号失败:', error);
        showAlert('删除账号失败', 'error');
    });
}

// 刷新账号列表
function refreshAccountsList() {
    console.log('刷新账号列表按钮被点击');
    showAlert('正在刷新账号列表...', 'info');
    loadAccountsList();
}

// 搜索账号
function searchAccounts() {
    const searchTerm = document.getElementById('accounts-search').value.trim().toLowerCase();
    const searchStats = document.getElementById('search-stats');
    const searchResultsCount = document.getElementById('search-results-count');
    
    if (searchTerm === '') {
        // 清除搜索
        isSearching = false;
        filteredAccountsData = [];
        searchStats.style.display = 'none';
        renderAccountsTable();
        return;
    }
    
    // 执行搜索
    isSearching = true;
    filteredAccountsData = accountsData.filter(account => {
        return (
            account.account.toLowerCase().includes(searchTerm) ||
            (account.x_username && account.x_username.toLowerCase().includes(searchTerm)) ||
            (account.proxy && account.proxy.toLowerCase().includes(searchTerm))
        );
    });
    
    // 显示搜索结果统计
    searchResultsCount.textContent = filteredAccountsData.length;
    searchStats.style.display = 'block';
    
    // 重新渲染表格
    renderAccountsTable();
}

// 清除搜索
function clearSearch() {
    document.getElementById('accounts-search').value = '';
    isSearching = false;
    filteredAccountsData = [];
    document.getElementById('search-stats').style.display = 'none';
    renderAccountsTable();
}

// 切换密码显示/隐藏
function togglePassword(accountName) {
    const passwordField = document.querySelector(`.password-field[data-account="${accountName}"]`);
    const toggleButton = passwordField.nextElementSibling;
    const icon = toggleButton.querySelector('i');
    
    if (passwordField.textContent === '***') {
        // 显示密码
        const password = passwordField.getAttribute('data-password');
        passwordField.textContent = password || '-';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        // 隐藏密码
        passwordField.textContent = '***';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 切换验证码显示/隐藏
function toggleVerifyCode(accountName) {
    const verifycodeField = document.querySelector(`.verifycode-field[data-account="${accountName}"]`);
    const toggleButton = verifycodeField.nextElementSibling;
    const icon = toggleButton.querySelector('i');
    
    if (verifycodeField.textContent === '***') {
        // 显示验证码
        const verifycode = verifycodeField.getAttribute('data-verifycode');
        verifycodeField.textContent = verifycode || '-';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        // 隐藏验证码
        verifycodeField.textContent = '***';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 切换新账号密码显示/隐藏
function toggleNewPassword() {
    const passwordInput = document.getElementById('newAccountPassword');
    const toggleButton = passwordInput.parentElement.querySelector('button');
    const icon = toggleButton.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        passwordInput.type = 'password';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 切换新账号验证码显示/隐藏
function toggleNewVerifyCode() {
    const verifycodeInput = document.getElementById('newAccountVerifyCode');
    const toggleButton = verifycodeInput.parentElement.querySelector('button');
    const icon = toggleButton.querySelector('i');
    
    if (verifycodeInput.type === 'password') {
        verifycodeInput.type = 'text';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        verifycodeInput.type = 'password';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 切换编辑账号密码显示/隐藏
function toggleEditPassword() {
    const passwordInput = document.getElementById('editAccountPassword');
    const toggleButton = passwordInput.parentElement.querySelector('button');
    const icon = toggleButton.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        passwordInput.type = 'password';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 切换编辑账号验证码显示/隐藏
function toggleEditVerifyCode() {
    const verifycodeInput = document.getElementById('editAccountVerifyCode');
    const toggleButton = verifycodeInput.parentElement.querySelector('button');
    const icon = toggleButton.querySelector('i');
    
    if (verifycodeInput.type === 'password') {
        verifycodeInput.type = 'text';
        icon.className = 'bi bi-eye-slash';
        toggleButton.classList.remove('btn-outline-secondary');
        toggleButton.classList.add('btn-outline-warning');
    } else {
        verifycodeInput.type = 'password';
        icon.className = 'bi bi-eye';
        toggleButton.classList.remove('btn-outline-warning');
        toggleButton.classList.add('btn-outline-secondary');
    }
}

// 显示多个账号的命令预览
function showMultipleAccountsCommand(accounts) {
    const accountsStr = accounts.join(',');
    
    // 获取当前配置表单的数据
    const formData = new FormData(document.getElementById('config-form'));
    const config = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            config[key] = value;
        }
    }
    
    // 处理复选框
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        config[checkbox.name] = checkbox.checked;
    });
    
    // 处理VPN设置
    if (config['vpn_auto']) {
        delete config['no_auto_vpn'];
        delete config['vpn_manual'];
    } else if (config['no_auto_vpn']) {
        delete config['vpn_auto'];
        delete config['vpn_manual'];
    } else if (config['vpn_manual']) {
        delete config['vpn_auto'];
        delete config['no_auto_vpn'];
    }
    
    // 构建完整命令
    let cmd = 'python xwool.py';
    
    // 添加参数
    for (let [key, value] of Object.entries(config)) {
        if (value !== null && value !== '' && value !== false) {
            if (typeof value === 'boolean' && value === true) {
                cmd += ` --${key}`;
            } else {
                cmd += ` --${key}`;
                cmd += ` ${value}`;
            }
        }
    }
    
    // 替换profile参数为多账号
    cmd = cmd.replace(/--profile [^ ]+/, `--profile ${accountsStr}`);
    
    let commandPreview = '批量启动命令预览:\n\n';
    commandPreview += `选中账号: ${accounts.join(', ')}\n\n`;
    commandPreview += `启动命令:\n`;
    commandPreview += `${cmd}\n\n`;
    commandPreview += `说明: 多个账号用逗号分隔，系统会自动处理每个账号`;
    
    // 创建模态框显示命令
    const modalHtml = `
        <div class="modal fade" id="commandModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">批量命令预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre class="bg-dark text-light p-3 rounded">${commandPreview}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="copyCommands()">复制命令</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除旧的模态框
    const oldModal = document.getElementById('commandModal');
    if (oldModal) {
        oldModal.remove();
    }
    
    // 添加新的模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('commandModal'));
    modal.show();
}

// 复制命令到剪贴板
function copyCommands() {
    const selectedAccounts = Array.from(document.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.value);
    
    const accountsStr = selectedAccounts.join(',');
    
    // 获取当前配置表单的数据
    const formData = new FormData(document.getElementById('config-form'));
    const config = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            config[key] = value;
        }
    }
    
    // 处理复选框
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        config[checkbox.name] = checkbox.checked;
    });
    
    // 处理VPN设置
    if (config['vpn_auto']) {
        delete config['no_auto_vpn'];
        delete config['vpn_manual'];
    } else if (config['no_auto_vpn']) {
        delete config['vpn_auto'];
        delete config['vpn_manual'];
    } else if (config['vpn_manual']) {
        delete config['vpn_auto'];
        delete config['no_auto_vpn'];
    }
    
    // 构建完整命令
    let cmd = 'python xwool.py';
    
    // 添加参数
    for (let [key, value] of Object.entries(config)) {
        if (value !== null && value !== '' && value !== false) {
            if (typeof value === 'boolean' && value === true) {
                cmd += ` --${key}`;
            } else {
                cmd += ` --${key}`;
                cmd += ` ${value}`;
            }
        }
    }
    
    // 替换profile参数为多账号
    cmd = cmd.replace(/--profile [^ ]+/, `--profile ${accountsStr}`);
    
    navigator.clipboard.writeText(cmd).then(() => {
        showAlert('命令已复制到剪贴板', 'success');
    }).catch(() => {
        showAlert('复制失败，请手动复制', 'warning');
    });
}

// 启动选中的账号
function startSelectedAccounts() {
    const selectedAccounts = Array.from(document.querySelectorAll('.account-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedAccounts.length === 0) {
        showAlert('请先选择要启动的账号', 'warning');
        return;
    }
    
    // 设置账号到配置表单（使用与单行启动按钮相同的机制）
    const profileSelect = document.getElementById('profile');
    if (profileSelect) {
        // 先清空所有选择
        profileSelect.value = '';
        // 如果是Select2，需要更新
        if ($('#profile').hasClass('select2-hidden-accessible')) {
            $('#profile').val([]).trigger('change');
        }
        
        // 然后设置新的账号
        if (selectedAccounts.length === 1) {
            profileSelect.value = selectedAccounts[0];
            // 如果是Select2，需要更新
            if ($('#profile').hasClass('select2-hidden-accessible')) {
                $('#profile').val(selectedAccounts).trigger('change');
            }
            
            // 设置标记，防止loadAccounts重新初始化时覆盖
            profileSelect.setAttribute('data-manually-set', 'true');
            profileSelect.setAttribute('data-manual-account', selectedAccounts[0]);
        } else {
            // 多个账号，用逗号连接
            const accountsString = selectedAccounts.join(',');
            profileSelect.value = accountsString;
            // 如果是Select2，需要更新
            if ($('#profile').hasClass('select2-hidden-accessible')) {
                $('#profile').val(selectedAccounts).trigger('change');
            }
            
            // 设置标记，防止loadAccounts重新初始化时覆盖
            profileSelect.setAttribute('data-manually-set', 'true');
            profileSelect.setAttribute('data-manual-account', accountsString);
        }
    }
    
    // 跳转到配置管理页面
    showSection('config');
    
    // 更新URL
    window.location.hash = '#/config';
    
    showAlert(`已选择 ${selectedAccounts.length} 个账号，请在配置管理页面确认设置后启动`, 'info');
}

// 直接启动单个账号（不跳转页面）
function startSingleAccountDirect(account) {
    // 获取当前配置
    getCurrentConfig().then(config => {
        // 设置账号到配置中
        config.profile = account;
        
        // 直接启动脚本
        startScriptWithConfig(config, account);
    });
}

// 直接启动多个账号（不跳转页面）
function startMultipleAccountsDirect(accounts) {
    // 获取当前配置
    getCurrentConfig().then(config => {
        // 设置多个账号到配置中
        config.profile = accounts.join(',');
        
        // 直接启动脚本
        startScriptWithConfig(config, accounts.join(', '));
    });
}

// 使用配置启动脚本
function startScriptWithConfig(config, accountInfo) {
    // 调试信息
    console.log('启动配置:', config);
    
    // 构建命令
    let cmd = 'python xwool.py';
    
    // 添加参数
    for (let [key, value] of Object.entries(config)) {
        if (value !== null && value !== '' && value !== false) {
            if (typeof value === 'boolean' && value === true) {
                cmd += ` --${key}`;
            } else {
                cmd += ` --${key} ${value}`;
            }
        }
    }
    
    console.log('生成的命令:', cmd);
    
    // 显示启动确认对话框
    const confirmMessage = `确定要启动以下账号吗？\n\n账号: ${accountInfo}\n\n命令: ${cmd}`;
    
    if (confirm(confirmMessage)) {
        // 发送启动请求
        fetch('/api/script/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({config: config})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`已启动账号: ${accountInfo}`, 'success');
                
                // 显示启动信息
                showStartInfoInStatusPage(cmd, accountInfo);
                
                // 更新状态
                updateStatus();
                updateRunningInfo();
            } else {
                showAlert(`启动失败: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('启动失败:', error);
            showAlert('启动失败，请检查网络连接', 'error');
        });
    }
}

// 在账号状态页面显示启动信息
function showStartInfoInStatusPage(cmd, accountInfo) {
    // 创建或获取启动信息显示区域
    let startInfoDisplay = document.getElementById('status-start-info-display');
    if (!startInfoDisplay) {
        startInfoDisplay = document.createElement('div');
        startInfoDisplay.id = 'status-start-info-display';
        startInfoDisplay.className = 'mt-3 p-3 bg-success bg-opacity-10 border border-success rounded';
        startInfoDisplay.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-success"><i class="bi bi-play-circle"></i> 脚本已启动</h6>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="closeStatusStartInfo()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="mb-2">
                <small class="text-muted">账号: <strong>${accountInfo}</strong></small>
            </div>
            <div class="bg-dark text-light p-2 rounded font-monospace" style="font-size: 0.9em; word-break: break-all;">
                ${cmd}
            </div>
            <div class="mt-2">
                <small class="text-success">
                    <i class="bi bi-info-circle"></i> 脚本正在后台运行，可以在"控制面板"查看运行状态
                </small>
            </div>
        `;
        
        // 插入到账号状态表格后面
        const statusSection = document.getElementById('status-section');
        const table = statusSection.querySelector('.table-responsive');
        table.parentNode.insertBefore(startInfoDisplay, table.nextSibling);
    } else {
        // 更新现有启动信息显示
        startInfoDisplay.querySelector('.text-muted strong').textContent = accountInfo;
        startInfoDisplay.querySelector('.font-monospace').textContent = cmd;
        startInfoDisplay.style.display = 'block';
    }
    
    // 滚动到启动信息显示区域
    startInfoDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// 关闭状态页面的启动信息显示
function closeStatusStartInfo() {
    const startInfoDisplay = document.getElementById('status-start-info-display');
    if (startInfoDisplay) {
        startInfoDisplay.style.display = 'none';
    }
}

// 全选账号
function selectAllAccounts() {
    document.querySelectorAll('.account-checkbox').forEach(cb => {
        cb.checked = true;
    });
    document.getElementById('select-all-checkbox').checked = true;
    updateSelectedCount();
}

// 取消全选账号
function deselectAllAccounts() {
    document.querySelectorAll('.account-checkbox').forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('select-all-checkbox').checked = false;
    updateSelectedCount();
}

// 切换全选
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const isChecked = selectAllCheckbox.checked;
    
    document.querySelectorAll('.account-checkbox').forEach(cb => {
        cb.checked = isChecked;
    });
    
    updateSelectedCount();
}

// 更新选中数量
function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.account-checkbox:checked').length;
    const totalCount = document.querySelectorAll('.account-checkbox').length;
    
    document.getElementById('selected-accounts').textContent = selectedCount;
    
    // 更新全选复选框状态
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    if (selectedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// 排序表格
function sortTable(column) {
    // 如果点击的是当前排序列，切换排序方向
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // 如果是新列，设置为升序
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // 更新表头图标
    updateSortIcons();
    
    // 排序数据
    filteredStatusData.sort((a, b) => {
        let aValue = a[column];
        let bValue = b[column];
        
        // 处理特殊字段的排序
        switch (column) {
            case 'num_visit':
                // 数字排序
                aValue = parseInt(aValue) || 0;
                bValue = parseInt(bValue) || 0;
                break;
            case 'update_time':
                // 时间排序
                aValue = aValue && aValue !== 'None' ? new Date(aValue) : new Date(0);
                bValue = bValue && bValue !== 'None' ? new Date(bValue) : new Date(0);
                break;
            case 'visit_date':
                // 日期排序
                aValue = aValue && aValue !== 'None' ? new Date(aValue) : new Date(0);
                bValue = bValue && bValue !== 'None' ? new Date(bValue) : new Date(0);
                break;
            case 'days_ago':
                // 天数排序（需要解析天数）
                aValue = parseDaysAgo(aValue);
                bValue = parseDaysAgo(bValue);
                break;
            default:
                // 字符串排序
                aValue = (aValue || '').toString().toLowerCase();
                bValue = (bValue || '').toString().toLowerCase();
        }
        
        // 比较值
        if (aValue < bValue) {
            return currentSortDirection === 'asc' ? -1 : 1;
        } else if (aValue > bValue) {
            return currentSortDirection === 'asc' ? 1 : -1;
        } else {
            return 0;
        }
    });
    
    // 重新渲染表格
    renderAccountStatusTable();
}

// 解析天数字符串为数字
function parseDaysAgo(daysAgoStr) {
    if (!daysAgoStr || daysAgoStr === '未知' || daysAgoStr === '时间解析错误') {
        return 999999; // 未知时间排在最后
    }
    
    if (daysAgoStr === '今天') {
        return 0;
    }
    
    if (daysAgoStr.includes('天前')) {
        return parseInt(daysAgoStr.replace('天前', ''));
    }
    
    if (daysAgoStr.includes('周前')) {
        return parseInt(daysAgoStr.replace('周前', '')) * 7;
    }
    
    if (daysAgoStr.includes('个月前')) {
        return parseInt(daysAgoStr.replace('个月前', '')) * 30;
    }
    
    return 999999; // 其他情况排在最后
}

// 更新排序图标
function updateSortIcons() {
    // 重置所有图标
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'bi bi-arrow-down-up';
    });
    
    // 设置当前排序列的图标
    if (currentSortColumn) {
        const currentHeader = document.querySelector(`th[onclick="sortTable('${currentSortColumn}')"]`);
        if (currentHeader) {
            const icon = currentHeader.querySelector('i');
            if (icon) {
                icon.className = currentSortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
            }
        }
    }
}

// 自动保存配置（带防抖）
function autoSaveConfig() {
    // 清除之前的定时器
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    // 设置新的定时器，500ms后执行保存
    autoSaveTimer = setTimeout(() => {
        const formData = new FormData(document.getElementById('config-form'));
        const config = {};
        
        // 收集表单数据
        for (let [key, value] of formData.entries()) {
            if (value !== '') {
                config[key] = value;
            }
        }
        
        // 处理复选框
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            config[checkbox.name] = checkbox.checked;
        });
        
        // 处理VPN设置
        if (config['vpn_auto']) {
            delete config['no_auto_vpn'];
            delete config['vpn_manual'];
        } else if (config['no_auto_vpn']) {
            delete config['vpn_auto'];
            delete config['vpn_manual'];
        } else if (config['vpn_manual']) {
            delete config['vpn_auto'];
            delete config['no_auto_vpn'];
        }
        
        // 保存配置
        fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: 'auto_saved_config',
                config: config
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('配置已自动保存');
                
                // 同时更新最后使用的配置
                return fetch('/api/config/update-last-used', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        config: config
                    })
                });
            } else {
                console.error('自动保存失败:', data.message);
                throw new Error(data.message);
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('最后使用配置已更新');
                
                // 显示保存成功提示
                const alert = document.getElementById('auto-save-alert');
                alert.style.display = 'block';
                alert.classList.add('show');
                
                // 2秒后自动隐藏提示
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 150);
                }, 2000);
            }
        })
        .catch(error => {
            console.error('自动保存错误:', error);
        });
    }, 500);
}

// 加载最后使用的配置
function loadLastUsedConfig() {
    console.log('开始加载最后使用的配置...');
    fetch('/api/config/last-used')
    .then(response => response.json())
    .then(data => {
        console.log('获取最后使用配置响应:', data);
        if (data.success && data.config && Object.keys(data.config).length > 0) {
            console.log('配置数据:', data.config);
            fillFormWithConfig(data.config);
            
            // 显示配置加载提示
            const alert = document.getElementById('config-loading-alert');
            const text = document.getElementById('config-loading-text');
            text.textContent = '已自动加载上次使用的配置参数';
            alert.style.display = 'block';
            alert.classList.add('show');
            
            // 3秒后自动隐藏提示
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 150);
            }, 3000);
            
            console.log('已加载最后使用的配置');
        } else {
            console.log('没有找到最后使用的配置或配置为空');
        }
    })
    .catch(error => {
        console.error('Error loading last used config:', error);
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 先加载账号，然后加载配置列表，最后加载最后使用的配置
    loadAccounts().then(() => {
        return loadConfigs();
    }).then(() => {
        // 账号和配置列表都加载完成后，延迟加载最后使用的配置
        setTimeout(() => {
            loadLastUsedConfig();
            
            // 测试配置加载功能
            setTimeout(() => {
                console.log('=== 测试配置加载功能 ===');
                console.log('Profile字段值:', document.getElementById('profile').value);
                console.log('Max interactions字段值:', document.getElementById('max_interactions').value);
                console.log('Headless复选框状态:', document.getElementById('headless').checked);
                console.log('Ad user复选框状态:', document.getElementById('ad_user').checked);
                console.log('No auto VPN复选框状态:', document.getElementById('no_auto_vpn').checked);
            }, 1000);
        }, 500);
    }).catch(error => {
        console.error('初始化失败:', error);
    });
    
    updateStatus();
    updateRunningInfo(); // 初始化时获取运行信息
    updateChromiumCount(); // 初始化时获取Chromium进程数量
    startLogPolling();
    startInputStatusCheck(); // 启动输入状态检查
    startStatsUpdate(); // 启动统计更新定时器
    
    // 确保页面加载时运行时长区域是隐藏的
    const runtimeSection = document.getElementById('runtime-section');
    if (runtimeSection) {
        runtimeSection.style.display = 'none';
    }
    
    // 确保页面加载时运行信息区域也是隐藏的
    const runningInfoSection = document.getElementById('running-info-section');
    if (runningInfoSection) {
        runningInfoSection.style.display = 'none';
    }
    
    // 初始化Bootstrap tooltip
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 监听表单变化，自动更新命令显示
    const form = document.getElementById('config-form');
    form.addEventListener('change', function() {
        if (commandSectionVisible) {
            generateCommand();
        }
        
        // 自动保存配置
        autoSaveConfig();
    });
    
    // 监听账号状态筛选
    document.getElementById('status-filter').addEventListener('input', filterAccounts);
    document.getElementById('status-filter-select').addEventListener('change', filterAccounts);
    
    // 监听VPN设置变化，确保互斥
    const vpnAutoCheckbox = document.getElementById('vpn_auto');
    
    vpnAutoCheckbox.addEventListener('change', function() {
        if (this.checked) {
            // 取消其他VPN选项
            document.getElementById('no_auto_vpn').checked = false;
            document.getElementById('vpn_manual').checked = false;
        }
    });
    
    // 监听其他VPN选项，确保互斥
    document.getElementById('no_auto_vpn').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('vpn_auto').checked = false;
            document.getElementById('vpn_manual').checked = false;
        }
    });
    
    document.getElementById('vpn_manual').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('vpn_auto').checked = false;
            document.getElementById('no_auto_vpn').checked = false;
        }
    });
    
    // 监听脚本输入框的回车键
    document.getElementById('script-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendInput();
        }
    });
    
    // 监听刷新间隔变化
    document.getElementById('refresh-interval').addEventListener('change', function() {
        const interval = parseInt(this.value);
        if (logInterval) {
            clearInterval(logInterval);
        }
        if (interval > 0) {
            logInterval = setInterval(() => {
                refreshAllLogs();
                updateStatus();
                updateRunningInfo(); // 更新运行信息
                updateChromiumCount(); // 更新Chromium进程数量
                checkForInputPrompt(); // 检查是否需要输入
            }, interval);
        }
    });
    
    // 绑定扩展检测复选框的change事件
    const doExtensionCheck = document.getElementById('do_extension_check');
    if (doExtensionCheck) {
        doExtensionCheck.addEventListener('change', toggleExtensionCheckParams);
        // 初始化状态
        toggleExtensionCheckParams();
    }
});

// 显示不同部分
function showSection(sectionName) {
    // 隐藏所有部分
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    
    // 显示选中的部分
    document.getElementById(sectionName + '-section').style.display = 'block';
    
    // 更新URL（但不触发hashchange事件）
    const newHash = '#/' + sectionName;
    if (window.location.hash !== newHash) {
        window.history.replaceState(null, null, newHash);
    }
    
    // 更新导航状态
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // 根据sectionName找到对应的导航链接并激活
    const navLinks = {
        'config': 'a[href="#/config"]',
        'control': 'a[href="#/control"]',
        'logs': 'a[href="#/logs"]',
        'status': 'a[href="#/status"]',
        'accounts': 'a[href="#/accounts"]',
        'donation': 'a[href="#/donation"]'
    };
    
    const selector = navLinks[sectionName];
    if (selector) {
        const activeLink = document.querySelector(selector);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
    
    // 如果是账号状态页面，加载数据
    if (sectionName === 'status') {
        loadAccountStatus();
    }
    
    // 如果是账号管理页面，加载数据
    if (sectionName === 'accounts') {
        loadAccountsList();
    }
    
    // 如果是控制面板，检查输入状态并加载run.log
    if (sectionName === 'control') {
        checkInputStatus();
        refreshControlRunLog();
        updateRunningInfo(); // 更新运行信息
    }
    
    // 如果是日志页面，检查输入状态
    if (sectionName === 'logs') {
        checkInputStatus();
    }
}

// 保存配置
function saveConfig() {
    const formData = new FormData(document.getElementById('config-form'));
    const config = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            config[key] = value;
        }
    }
    
    // 处理复选框
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        config[checkbox.name] = checkbox.checked;
    });
    
    // 处理VPN设置
    if (config['vpn_auto']) {
        // 自动切换VPN - 需要用户手动输入VPN配置
        // 这里可以添加提示或验证
        // 移除其他VPN选项
        delete config['no_auto_vpn'];
        delete config['vpn_manual'];
    } else if (config['no_auto_vpn']) {
        // 跳过VPN设置
        delete config['vpn_auto'];
        delete config['vpn_manual'];
    } else if (config['vpn_manual']) {
        // 手动设置VPN
        delete config['vpn_auto'];
        delete config['no_auto_vpn'];
    }
    
    const configName = prompt('请输入配置名称:', `config_${Date.now()}`);
    if (!configName) return;
    
    fetch('/api/config/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: configName,
            config: config
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('配置保存成功！', 'success');
            loadConfigs();
        } else {
            showAlert('保存失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('保存失败: ' + error.message, 'danger');
    });
}

// 显示/隐藏执行命令
function toggleCommand() {
    const commandSection = document.getElementById('command-section');
    const toggleButton = document.querySelector('button[onclick="toggleCommand()"]');
    
    if (commandSectionVisible) {
        // 隐藏命令区域
        commandSection.style.display = 'none';
        toggleButton.innerHTML = `<i class="bi bi-terminal"></i> <span data-i18n="config.show_command">预览命令</span>`;
        toggleButton.className = 'btn btn-info me-2';
        commandSectionVisible = false;
    } else {
        // 显示命令区域
        generateCommand();
        commandSection.style.display = 'block';
        toggleButton.innerHTML = `<i class="bi bi-eye-slash"></i> <span data-i18n="config.hide_command">隐藏命令</span>`;
        toggleButton.className = 'btn btn-secondary me-2';
        commandSectionVisible = true;
    }
    
    // 重新应用翻译到新创建的元素
    applyTranslations();
}

// 生成执行命令
function generateCommand() {
    const formData = new FormData(document.getElementById('config-form'));
    const config = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            config[key] = value;
        }
    }
    
    // 处理复选框
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        config[checkbox.name] = checkbox.checked;
    });
    
    // 特殊处理profile多选
    const profileSelect = document.getElementById('profile');
    if (profileSelect && profileSelect.multiple) {
        const selectedProfiles = Array.from(profileSelect.selectedOptions).map(option => option.value);
        if (selectedProfiles.length > 0) {
            config['profile'] = selectedProfiles.join(',');
        }
    }
    
    // 处理VPN设置
    if (config['vpn_auto']) {
        // 自动切换VPN - 需要用户手动输入VPN配置
        // 这里可以添加提示或验证
        // 移除其他VPN选项
        delete config['no_auto_vpn'];
        delete config['vpn_manual'];
    } else if (config['no_auto_vpn']) {
        // 跳过VPN设置
        delete config['vpn_auto'];
        delete config['vpn_manual'];
    } else if (config['vpn_manual']) {
        // 手动设置VPN
        delete config['vpn_auto'];
        delete config['no_auto_vpn'];
    }
    
    // 构建命令
    let cmd = 'python xwool.py';
    
    // 添加参数
    for (let [key, value] of Object.entries(config)) {
        if (value !== null && value !== '' && value !== false) {
            if (typeof value === 'boolean' && value === true) {
                cmd += ` --${key}`;
            } else {
                cmd += ` --${key} ${value}`;
            }
        }
    }
    
    // 显示命令
    document.getElementById('command-display').textContent = cmd;
}

// 全局变量存储账号数据
let accountDataMap = {};

// 加载账号列表
function loadAccounts() {
    return fetch('/api/accounts')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('profile');
            
            // 先销毁现有的Select2
            try {
                $('#profile').select2('destroy');
            } catch (e) {
                console.log('Select2销毁失败，可能未初始化:', e);
            }
            
            // 清空选项
            select.innerHTML = '<option value="" data-i18n="config.profile_placeholder">请选择账号...</option>';
            
            // 去重添加账号选项
            const uniqueAccounts = [...new Set(data.accounts)];
            uniqueAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                select.appendChild(option);
            });
            
            // 保存账号数据到全局变量
            accountDataMap = data.account_data || {};
            
            // 重新初始化Select2
            $('#profile').select2({
                theme: 'bootstrap-5',
                placeholder: getTranslation('config.profile_placeholder'),
                allowClear: true,
                multiple: true,
                width: '100%',
                language: {
                    noResults: function() {
                        return '没有找到匹配的账号';
                    },
                    searching: function() {
                        return '搜索中...';
                    }
                }
            });
            
            // 添加Select2选择事件监听
            $('#profile').on('change', function() {
                // 获取所有选中的值并去重
                const selectedValues = $(this).val() || [];
                const uniqueSelectedValues = [...new Set(selectedValues)];
                showProxyInfo(uniqueSelectedValues);
            });
            
            // 检查是否有手动设置的账号，如果有则恢复
            const manuallySetAccount = select.getAttribute('data-manual-account');
            if (manuallySetAccount && select.getAttribute('data-manually-set') === 'true') {
                // 恢复手动设置的账号
                let accountsToSet;
                if (manuallySetAccount.includes(',')) {
                    // 多个账号，用逗号分隔
                    accountsToSet = manuallySetAccount.split(',').map(acc => acc.trim());
                } else {
                    // 单个账号
                    accountsToSet = [manuallySetAccount];
                }
                
                $('#profile').val(accountsToSet).trigger('change');
                
                // 清除标记
                select.removeAttribute('data-manually-set');
                select.removeAttribute('data-manual-account');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// 全选Profile
function selectAllProfiles() {
    const select = document.getElementById('profile');
    const options = Array.from(select.options);
    
    // 排除空选项
    const validOptions = options.filter(option => option.value !== '');
    
    // 检查是否已经全选
    const alreadySelected = validOptions.every(option => option.selected);
    if (alreadySelected) {
        showAlert('已经全选了所有账号', 'info');
        return;
    }
    
    // 先取消所有选择
    options.forEach(option => {
        option.selected = false;
    });
    
    // 然后设置所有有效选项为选中状态
    validOptions.forEach(option => {
        option.selected = true;
    });
    
    // 如果使用Select2，需要触发change事件
    if ($('#profile').hasClass('select2-hidden-accessible')) {
        const validValues = validOptions.map(option => option.value);
        $('#profile').val(validValues).trigger('change');
    }
    
    // Select2的trigger('change')已经会触发事件，无需额外触发
    
    showAlert(`已全选 ${validOptions.length} 个账号`, 'success');
}

// 取消全选Profile
function deselectAllProfiles() {
    const select = document.getElementById('profile');
    const options = Array.from(select.options);
    
    // 检查是否已经全部取消选择
    const alreadyDeselected = options.every(option => !option.selected);
    if (alreadyDeselected) {
        showAlert('已经取消全选了', 'info');
        return;
    }
    
    // 取消所有选项的选中状态
    options.forEach(option => {
        option.selected = false;
    });
    
    // 如果使用Select2，需要触发change事件
    if ($('#profile').hasClass('select2-hidden-accessible')) {
        $('#profile').val([]).trigger('change');
    }
    
    // Select2的trigger('change')已经会触发事件，无需额外触发
    
    showAlert('已取消全选', 'success');
}

// 清空Profile选择
function clearProfileSelection() {
    console.log('清空Profile选择被调用');
    
    const select = document.getElementById('profile');
    if (!select) {
        console.error('未找到profile选择框');
        return;
    }
    
    const options = Array.from(select.options);
    console.log('当前选项数量:', options.length);
    
    // 取消所有选项的选中状态
    options.forEach(option => {
        option.selected = false;
    });
    
    // 如果使用Select2，需要触发change事件
    if ($('#profile').hasClass('select2-hidden-accessible')) {
        console.log('使用Select2刷新');
        $('#profile').val([]).trigger('change');
    } else {
        console.log('未使用Select2');
    }
    
    // Select2的trigger('change')已经会触发事件，无需额外触发
    
    // 显示提示信息
    showAlert('已清空账号选择', 'info');
    
    console.log('清空Profile选择完成');
}

// 显示代理信息
function showProxyInfo(account) {
    const proxyInfo = document.getElementById('proxy-info');
    const proxyValue = document.getElementById('proxy-value');
    
    if (account) {
        // 处理多选情况
        const selectedAccounts = Array.isArray(account) ? account : [account];
        const proxies = [];
        
        selectedAccounts.forEach(acc => {
            if (accountDataMap[acc] && accountDataMap[acc].proxy) {
                proxies.push(accountDataMap[acc].proxy);
            }
        });
        
        if (proxies.length > 0) {
            // 去重显示代理
            const uniqueProxies = [...new Set(proxies)];
            proxyValue.textContent = uniqueProxies.join(', ');
            proxyInfo.style.display = 'block';
            // 获取并显示当前代理信息
            getCurrentProxyInfo();
        } else {
            proxyInfo.style.display = 'none';
            document.getElementById('current-proxy-info').style.display = 'none';
        }
    } else {
        proxyInfo.style.display = 'none';
        document.getElementById('current-proxy-info').style.display = 'none';
    }
}

// 获取当前代理信息
function getCurrentProxyInfo() {
    const currentProxyInfo = document.getElementById('current-proxy-info');
    const refreshBtn = document.querySelector('#current-proxy-info .btn');
    
    // 保存原始按钮内容
    const originalContent = `<i class="bi bi-arrow-clockwise"></i> ${getTranslation('common.refresh')}`;
    
    // 立即显示代理信息区域并设置为正在获取状态
    currentProxyInfo.style.display = 'block';
    
    // 显示正在获取状态
    const currentCountry = document.getElementById('current-country');
    const currentCountryCode = document.getElementById('current-country-code');
    const currentIp = document.getElementById('current-ip');
    
    currentCountry.textContent = getTranslation('common.loading');
    currentCountryCode.textContent = getTranslation('common.loading');
    currentIp.textContent = getTranslation('common.loading');
    
    // 设置按钮为不可点击状态并开始倒计时
    refreshBtn.disabled = true;
    let countdown = 5;
    refreshBtn.innerHTML = `<i class="bi bi-arrow-clockwise spin"></i> ${getTranslation('control.refreshing')} ${countdown}${getTranslation('control.seconds_remaining')}`;
    
    // 开始倒计时
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            refreshBtn.innerHTML = `<i class="bi bi-arrow-clockwise spin"></i> ${getTranslation('control.refreshing')} ${countdown}${getTranslation('control.seconds_remaining')}`;
        } else {
            // 倒计时结束，停止旋转动画，但保持禁用状态直到API返回
            refreshBtn.innerHTML = `<i class="bi bi-arrow-clockwise"></i> ${getTranslation('control.refreshing')}`;
        }
    }, 1000);
    
    fetch('/api/proxy/current-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新代理信息
            currentCountry.textContent = data.data.country;
            currentCountryCode.textContent = data.data.country_code;
            currentIp.textContent = data.data.ip;
        } else {
            console.error('获取当前代理信息失败:', data.message);
            // 显示错误状态
            currentCountry.textContent = getTranslation('errors.proxy_info_failed');
            currentCountryCode.textContent = getTranslation('errors.proxy_info_failed');
            currentIp.textContent = getTranslation('errors.proxy_info_failed');
        }
    })
    .catch(error => {
        console.error('Error getting current proxy info:', error);
        // 显示错误状态
        currentCountry.textContent = getTranslation('errors.proxy_info_failed');
        currentCountryCode.textContent = getTranslation('errors.proxy_info_failed');
        currentIp.textContent = getTranslation('errors.proxy_info_failed');
    })
    .finally(() => {
        // 清理倒计时定时器
        clearInterval(countdownInterval);
        
        // 恢复按钮状态
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalContent;
    });
}

// 加载配置列表
function loadConfigs() {
    return fetch('/api/config/list')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('config-select');
            select.innerHTML = '<option value="" data-i18n="config.config_select_placeholder">请选择配置...</option>';
            
            Object.keys(data.configs).forEach(configName => {
                const config = data.configs[configName];
                const option = document.createElement('option');
                option.value = configName;
                option.textContent = configName;
                select.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// 加载选中的配置
function loadSelectedConfig() {
    const configName = document.getElementById('config-select').value;
    if (!configName) {
        showAlert('请先选择配置', 'warning');
        return;
    }
    
    fetch(`/api/config/${configName}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentConfig = data.config.config;
            fillFormWithConfig(currentConfig);
            showAlert('配置加载成功！', 'success');
        } else {
            showAlert('加载失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('加载失败: ' + error.message, 'danger');
    });
}

// 用配置填充表单
function fillFormWithConfig(config) {
    console.log('开始填充表单，配置:', config);
    
    // 检查表单元素是否存在
    const form = document.getElementById('config-form');
    if (!form) {
        console.error('未找到config-form表单元素');
        return;
    }
    
    // 清空表单
    if (form.reset && typeof form.reset === 'function') {
        form.reset();
    } else {
        console.warn('表单reset方法不可用，跳过清空操作');
    }
    
    // 填充值
    Object.keys(config).forEach(key => {
        const element = document.getElementById(key);
        console.log(`处理字段 ${key}:`, element, '值:', config[key]);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = config[key];
                console.log(`设置复选框 ${key}:`, element.checked);
            } else if (element.tagName === 'SELECT') {
                element.value = config[key];
                console.log(`设置选择框 ${key}:`, element.value);
                // 如果是Bootstrap Select，需要刷新
                if (element.id === 'profile') {
                    // 处理多选情况，将逗号分隔的字符串转换为数组
                    let profileValues = config[key];
                    if (typeof profileValues === 'string' && profileValues.includes(',')) {
                        profileValues = profileValues.split(',').map(p => p.trim()).filter(p => p);
                    } else if (typeof profileValues === 'string') {
                        profileValues = [profileValues];
                    }
                    
                    // 使用Select2的val方法设置值
                    $('#profile').val(profileValues).trigger('change');
                    // 显示proxy信息
                    showProxyInfo(profileValues);
                }
            } else {
                element.value = config[key];
                console.log(`设置输入框 ${key}:`, element.value);
            }
        } else {
            console.log(`未找到元素: ${key}`);
        }
    });
    
    // 处理VPN设置
    // 重置所有VPN选项
    document.getElementById('vpn_auto').checked = false;
    document.getElementById('no_auto_vpn').checked = false;
    document.getElementById('vpn_manual').checked = false;
    
    if (config['vpn_auto']) {
        // 自动切换VPN
        document.getElementById('vpn_auto').checked = true;
        console.log('设置VPN自动模式');
    } else if (config['no_auto_vpn']) {
        // 跳过VPN设置
        document.getElementById('no_auto_vpn').checked = true;
        console.log('设置VPN跳过模式');
    } else if (config['vpn_manual']) {
        // 手动设置VPN
        document.getElementById('vpn_manual').checked = true;
        console.log('设置VPN手动模式');
    } else {
        // 如果没有VPN配置，默认选中手动设置VPN
        document.getElementById('vpn_manual').checked = true;
        console.log('默认设置VPN手动模式');
    }
    
    // 更新扩展检测参数的状态
    toggleExtensionCheckParams();
    
    // 更新无头模式标签显示
    toggleHeadlessLabel();
    
    // 更新强制运行标签显示
    toggleForceLabel();
    
    console.log('表单填充完成');
}

// 启动脚本
function startScript() {
    const formData = new FormData(document.getElementById('config-form'));
    const config = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            config[key] = value;
        }
    }
    
    // 处理复选框
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        config[checkbox.name] = checkbox.checked;
    });
    
    // 特殊处理profile多选
    const profileSelect = document.getElementById('profile');
    if (profileSelect && profileSelect.multiple) {
        const selectedProfiles = Array.from(profileSelect.selectedOptions).map(option => option.value);
        if (selectedProfiles.length > 0) {
            config['profile'] = selectedProfiles.join(',');
        }
    }
    
    // 处理VPN设置
    if (config['vpn_auto']) {
        // 自动切换VPN - 需要用户手动输入VPN配置
        // 这里可以添加提示或验证
        // 移除其他VPN选项
        delete config['no_auto_vpn'];
        delete config['vpn_manual'];
    } else if (config['no_auto_vpn']) {
        // 跳过VPN设置
        delete config['vpn_auto'];
        delete config['vpn_manual'];
    } else if (config['vpn_manual']) {
        // 手动设置VPN
        delete config['vpn_auto'];
        delete config['no_auto_vpn'];
    }
    
    // 如果命令区域可见，更新命令显示
    if (commandSectionVisible) {
        generateCommand();
    }
    
    fetch('/api/script/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ config: config })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('脚本启动成功！', 'success');
            updateStatus();
            
            // 延迟更新进程数量，等待脚本完全启动
            setTimeout(() => {
                updateChromiumCount();
            }, 2000);
            
            // 启动成功后，开始倒计时并自动跳转到控制面板
            startCountdownAndRedirect();
        } else {
            showAlert('启动失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('启动失败: ' + error.message, 'danger');
    });
}

// 倒计时并自动跳转到控制面板
function startCountdownAndRedirect() {
    let countdown = 5;
    
    // 创建倒计时提示框
    const countdownAlert = document.createElement('div');
    countdownAlert.className = 'alert alert-info alert-dismissible fade show position-fixed';
    countdownAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    countdownAlert.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>
                <strong data-i18n="config.script_started_success">脚本启动成功！</strong><br>
                <span id="countdown-text">${countdown}<span data-i18n="config.auto_redirect_countdown">秒后自动跳转到指挥中心...</span></span>
            </div>
            <button type="button" class="btn-close ms-auto" onclick="clearCountdown()"></button>
        </div>
    `;
    
    document.body.appendChild(countdownAlert);
    
    // 更新倒计时文本
    const countdownText = document.getElementById('countdown-text');
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownText) {
            countdownText.innerHTML = `${countdown}<span data-i18n="config.auto_redirect_countdown">秒后自动跳转到指挥中心...</span>`;
            // 重新应用翻译到新创建的元素
            applyTranslations();
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            clearCountdown();
            // 跳转到控制面板
            showSection('control');
        }
    }, 1000);
    
    // 保存倒计时ID以便可以取消
    window.countdownInterval = countdownInterval;
    window.countdownAlert = countdownAlert;
}

// 清除倒计时
function clearCountdown() {
    if (window.countdownInterval) {
        clearInterval(window.countdownInterval);
        window.countdownInterval = null;
    }
    if (window.countdownAlert) {
        window.countdownAlert.remove();
        window.countdownAlert = null;
    }
}

// 停止脚本
function stopScript() {
    fetch('/api/script/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('脚本已停止！', 'success');
            updateStatus();
            
            // 立即停止运行时长更新定时器
            stopRuntimeUpdate();
            
            // 立即更新运行信息，隐藏运行时长区域
            updateRunningInfo();
            
            // 更新Chromium进程数量
            updateChromiumCount();
        } else {
            showAlert('停止失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('停止失败: ' + error.message, 'danger');
    });
}

// 清理残留进程
function cleanupProcesses() {
    if (confirm('确定要清理所有残留的Chromium进程吗？')) {
        fetch('/api/script/cleanup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // 清理后更新进程数量
                updateChromiumCount();
            } else {
                showAlert('清理失败: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('清理失败: ' + error.message, 'danger');
        });
    }
}

// 获取Chromium进程数量
function updateChromiumCount() {
    console.log('正在更新Chromium进程数量...');
    fetch('/api/script/chromium-count')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const count = data.count;
            const countElement = document.getElementById('chromium-count');
            const cleanupBtn = document.getElementById('cleanup-btn');
            
            console.log('当前Chromium进程数量:', count);
            console.log('进程检测详情:', data);
            
            // 更新显示的数量
            countElement.textContent = count;
            
            // 根据数量控制按钮状态
            if (count > 0) {
                cleanupBtn.disabled = false;
                cleanupBtn.className = 'btn btn-warning';
                console.log('清理进程按钮已启用');
            } else {
                cleanupBtn.disabled = true;
                cleanupBtn.className = 'btn btn-secondary';
                console.log('清理进程按钮已禁用');
            }
        } else {
            console.error('获取进程数量失败:', data.message);
        }
    })
    .catch(error => {
        console.error('Error getting chromium count:', error);
    });
}

// 更新状态
function updateStatus() {
    fetch('/api/script/status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const status = data.status;
            const statusBadge = document.getElementById('status-badge');
            const controlStatus = document.getElementById('control-status');
            
            if (status === 'running') {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = `<span data-i18n="control.status">状态</span>: <span data-i18n="control.running">运行中</span>`;
                controlStatus.className = 'badge bg-success';
                controlStatus.setAttribute('data-i18n', 'control.running');
                controlStatus.textContent = getTranslation('control.running');
                
                // 禁用启动按钮，启用停止按钮
                const startButton = document.getElementById('start-button');
                const stopButton = document.getElementById('stop-button');
                if (startButton) {
                    startButton.disabled = true;
                    startButton.classList.remove('btn-success');
                    startButton.classList.add('btn-secondary');
                }
                if (stopButton) {
                    stopButton.disabled = false;
                    stopButton.classList.remove('btn-secondary');
                    stopButton.classList.add('btn-danger');
                }
            } else {
                statusBadge.className = 'badge bg-secondary';
                statusBadge.innerHTML = `<span data-i18n="control.status">状态</span>: <span data-i18n="control.stopped">停止</span>`;
                controlStatus.className = 'badge bg-secondary';
                controlStatus.setAttribute('data-i18n', 'control.stopped');
                controlStatus.textContent = getTranslation('control.stopped');
                
                // 启用启动按钮，禁用停止按钮
                const startButton = document.getElementById('start-button');
                const stopButton = document.getElementById('stop-button');
                if (startButton) {
                    startButton.disabled = false;
                    startButton.classList.remove('btn-secondary');
                    startButton.classList.add('btn-success');
                }
                if (stopButton) {
                    stopButton.disabled = true;
                    stopButton.classList.remove('btn-danger');
                    stopButton.classList.add('btn-secondary');
                }
            }
            
            // 重新应用翻译到新创建的元素
            applyTranslations();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// 获取并显示运行信息
function updateRunningInfo() {
    console.log('开始获取运行信息...');
    fetch('/api/script/running-info')
    .then(response => response.json())
    .then(data => {
        console.log('获取到的运行信息:', data);
        if (data.success) {
            const runningInfoSection = document.getElementById('running-info-section');
            const runtimeSection = document.getElementById('runtime-section');
            
            console.log('运行状态:', data.data.status);
            console.log('运行信息区域元素:', runningInfoSection);
            console.log('运行时长区域元素:', runtimeSection);
            
            if (data.data.status === 'running') {
                console.log('脚本正在运行，显示运行信息');
                // 显示运行信息
                document.getElementById('running-account').textContent = data.data.account;
                document.getElementById('start-time').textContent = formatDateTime(data.data.start_time);
                document.getElementById('process-pid').textContent = data.data.pid;
                document.getElementById('full-command').textContent = data.data.full_command;
                
                // 显示运行时长
                document.getElementById('runtime-display').textContent = data.data.runtime;
                runtimeSection.style.display = 'block';
                
                // 显示参数说明
                const parametersList = document.getElementById('parameters-list');
                parametersList.innerHTML = '';
                data.data.parameters.forEach(param => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info me-1 mb-1';
                    badge.textContent = param;
                    parametersList.appendChild(badge);
                });
                
                runningInfoSection.style.display = 'block';
                console.log('运行信息已显示');
                
                // 启动运行时长自动更新定时器
                startRuntimeUpdate(data.data.start_time);
                
                // 加载今日数据统计
                loadTodayStats(data.data.account);
                
                // 隐藏手动刷新按钮（脚本运行时不需要）
                hideManualRefreshButton();
            } else {
                console.log('脚本未运行，隐藏运行信息');
                runningInfoSection.style.display = 'none';
                runtimeSection.style.display = 'none';
                
                // 停止运行时长更新定时器
                stopRuntimeUpdate();
                
                // 保留今日数据统计显示，但停止自动刷新
                // 显示手动刷新按钮
                showManualRefreshButton();
                
                // 确保今日数据统计区域保持显示
                const todayStatsSection = document.getElementById('today-stats-section');
                if (todayStatsSection) {
                    todayStatsSection.style.display = 'block';
                }
            }
        } else {
            console.error('获取运行信息失败:', data.message);
        }
    })
    .catch(error => {
        console.error('Error getting running info:', error);
    });
}

// 运行时长更新定时器
let runtimeUpdateTimer = null;

// 启动运行时长自动更新
function startRuntimeUpdate(startTime) {
    // 清除之前的定时器
    stopRuntimeUpdate();
    
    // 立即更新一次
    updateRuntimeDisplay(startTime);
    
    // 每秒更新一次运行时长
    runtimeUpdateTimer = setInterval(() => {
        updateRuntimeDisplay(startTime);
    }, 1000);
}

// 停止运行时长更新
function stopRuntimeUpdate() {
    if (runtimeUpdateTimer) {
        clearInterval(runtimeUpdateTimer);
        runtimeUpdateTimer = null;
        console.log('运行时长更新定时器已停止');
    }
    
    // 清空运行时长显示
    const runtimeDisplay = document.getElementById('runtime-display');
    if (runtimeDisplay) {
        runtimeDisplay.textContent = '0秒';
    }
}

// 更新运行时长显示
function updateRuntimeDisplay(startTime) {
    if (!startTime) return;
    
    // 多重检查：确保脚本确实在运行
    const runningInfoSection = document.getElementById('running-info-section');
    const runtimeSection = document.getElementById('runtime-section');
    
    // 如果运行信息区域已隐藏，说明脚本已停止，不更新运行时长
    if (runningInfoSection && runningInfoSection.style.display === 'none') {
        console.log('运行信息区域已隐藏，停止更新运行时长');
        return;
    }
    
    // 如果运行时长区域已隐藏，也不更新
    if (runtimeSection && runtimeSection.style.display === 'none') {
        console.log('运行时长区域已隐藏，停止更新运行时长');
        return;
    }
    
    // 检查状态徽章，确认脚本状态
    const statusBadge = document.getElementById('status-badge');
    if (statusBadge && statusBadge.textContent.includes('停止')) {
        console.log('脚本状态显示已停止，停止更新运行时长');
        return;
    }
    
    try {
        const startDate = new Date(startTime);
        const now = new Date();
        const runtime = now - startDate;
        
        // 格式化运行时长
        const totalSeconds = Math.floor(runtime / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        let runtimeStr = '';
        if (hours > 0) {
            runtimeStr = `${hours}小时${minutes}分钟${seconds}秒`;
        } else if (minutes > 0) {
            runtimeStr = `${minutes}分钟${seconds}秒`;
        } else {
            runtimeStr = `${seconds}秒`;
        }
        
        // 更新显示
        const runtimeDisplay = document.getElementById('runtime-display');
        if (runtimeDisplay) {
            runtimeDisplay.textContent = runtimeStr;
        }
    } catch (error) {
        console.error('更新运行时长失败:', error);
    }
}

// 格式化日期时间
function formatDateTime(isoString) {
    if (!isoString) return '未知';
    const date = new Date(isoString);
    
    // 格式化为 yyyy-mm-dd hh:MM:SS
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 刷新日志
function refreshLogs() {
    fetch('/api/logs')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '';
            
            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                logLine.textContent = log;
                logContainer.appendChild(logLine);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// 为日志行添加颜色分类
function addLogColors(logText) {
    // 匹配时间戳和日志级别
    return logText.replace(
        /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) (INFO|WARNING|ERROR|DEBUG|SUCCESS) (.+)/g,
        '<div class="log-line $2.toLowerCase()">$1 <strong>$2</strong> $3</div>'
    );
}

// 刷新所有日志
function refreshAllLogs() {
    // 刷新server.log
    fetch('/api/logs/server')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const logContainer = document.getElementById('server-log-container');
            logContainer.innerHTML = '';
            
            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                // 添加颜色分类
                logLine.innerHTML = addLogColors(log);
                logContainer.appendChild(logLine);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error refreshing server logs:', error);
    });
    
    // 刷新run.log
    fetch('/api/logs/run')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const logContainer = document.getElementById('run-log-container');
            logContainer.innerHTML = '';
            
            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                // 添加颜色分类
                logLine.innerHTML = addLogColors(log);
                logContainer.appendChild(logLine);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error refreshing run logs:', error);
    });
    
    // 检查输入状态
    checkInputStatus();
}

// 清空日志
function clearLogs() {
    document.getElementById('log-container').innerHTML = '<div class="text-muted">日志已清空...</div>';
}

// 清空所有日志
function clearAllLogs() {
    document.getElementById('server-log-container').innerHTML = '<div class="text-muted">server.log已清空...</div>';
    document.getElementById('run-log-container').innerHTML = '<div class="text-muted">run.log已清空...</div>';
}

// 刷新控制面板run.log
function refreshControlRunLog() {
    fetch('/api/logs/run')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const logContainer = document.getElementById('control-run-log-container');
            logContainer.innerHTML = '';
            
            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                // 添加颜色分类
                logLine.innerHTML = addLogColors(log);
                logContainer.appendChild(logLine);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error refreshing control run logs:', error);
    });
}

// 清空控制面板run.log
function clearControlRunLog() {
    document.getElementById('control-run-log-container').innerHTML = '<div class="text-muted">run.log已清空...</div>';
}

// 发送输入到脚本
function sendInput() {
    const input = document.getElementById('script-input').value;
    if (!input.trim()) {
        showAlert('请输入内容', 'warning');
        return;
    }
    
    fetch('/api/script/input', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            input: input
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 清空输入框
            document.getElementById('script-input').value = '';
            // 刷新日志
            refreshAllLogs();
            // 延迟检查输入状态，确保日志已更新
            setTimeout(() => {
                checkInputStatus();
            }, 1000);
        } else {
            showAlert('发送输入失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('发送输入失败: ' + error.message, 'danger');
    });
}

// 检查脚本是否需要输入 (已废弃，使用 checkInputStatus 替代)
function checkForInputPrompt() {
    // 调用新的检查函数
    checkInputStatus();
}

// 开始日志轮询
function startLogPolling() {
    const interval = parseInt(document.getElementById('refresh-interval').value);
    if (interval > 0) {
        logInterval = setInterval(() => {
            refreshAllLogs();
            updateStatus();
            updateRunningInfo(); // 更新运行信息
            updateChromiumCount(); // 更新Chromium进程数量
            checkForInputPrompt(); // 检查是否需要输入
        }, interval);
    }
}

// 页面卸载时清理
window.addEventListener('beforeunload', function() {
    if (logInterval) {
        clearInterval(logInterval);
    }
});

// 加载今日数据统计
function loadTodayStats(profile) {
    if (!profile) return;
    
    fetch(`/api/script/account-stats/${profile}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTodayStats(data.data);
            } else {
                console.error('加载统计失败:', data.message);
            }
        })
        .catch(error => {
            console.error('加载统计失败:', error);
        });
}

// 显示今日数据统计
function displayTodayStats(stats) {
    const statsSection = document.getElementById('today-stats-section');
    
    if (statsSection) {
        // 更新统计数据
        document.getElementById('stats-follow').textContent = stats.follow;
        document.getElementById('stats-like').textContent = stats.like;
        document.getElementById('stats-reply').textContent = stats.reply;
        document.getElementById('stats-total').textContent = stats.total;
        
        // 更新标题，显示日期
        const today = new Date().toISOString().split('T')[0]; // 格式: YYYY-MM-DD
        document.getElementById('stats-title').textContent = `今日数据统计(${today})`;
        
        // 更新时间为当前时间
        const now = new Date();
        const updateTime = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }).replace(/\//g, '-');
        document.getElementById('stats-update-time').textContent = updateTime;
        
        // 显示统计区域
        statsSection.style.display = 'block';
        
        // 启动倒计时
        startCountdown();
        
        console.log('今日数据统计已显示:', stats);
    }
}

// 统计更新定时器
let statsUpdateTimer = null;
let statsCountdownTimer = null;
let countdownSeconds = 5;

// 更新今日数据统计（定时刷新）
function updateTodayStats() {
    const runningAccount = document.getElementById('running-account');
    if (runningAccount && runningAccount.textContent && runningAccount.textContent !== '未知') {
        loadTodayStats(runningAccount.textContent);
    }
}

// 启动统计更新定时器
function startStatsUpdate() {
    // 清除之前的定时器
    stopStatsUpdate();
    
    // 启动倒计时
    startCountdown();
    
    // 每5秒更新一次统计数据
    statsUpdateTimer = setInterval(() => {
        updateTodayStats();
        // 重置倒计时
        countdownSeconds = 5;
        updateCountdown();
    }, 5 * 1000);
}

// 停止统计更新定时器
function stopStatsUpdate() {
    if (statsUpdateTimer) {
        clearInterval(statsUpdateTimer);
        statsUpdateTimer = null;
    }
    if (statsCountdownTimer) {
        clearInterval(statsCountdownTimer);
        statsCountdownTimer = null;
    }
    
    // 更新倒计时显示为"已停止"
    const countdownElement = document.getElementById('stats-countdown');
    if (countdownElement) {
        countdownElement.textContent = '已停止';
    }
}

// 启动倒计时
function startCountdown() {
    // 清除之前的倒计时定时器
    if (statsCountdownTimer) {
        clearInterval(statsCountdownTimer);
    }
    
    countdownSeconds = 5;
    updateCountdown();
    
    statsCountdownTimer = setInterval(() => {
        countdownSeconds--;
        updateCountdown();
        
        // 倒计时到0时，等待下一次统计更新
        if (countdownSeconds <= 0) {
            countdownSeconds = 0;
        }
    }, 1000);
}

// 更新倒计时显示
function updateCountdown() {
    const countdownElement = document.getElementById('stats-countdown');
    if (countdownElement) {
        countdownElement.textContent = countdownSeconds;
    }
}

// 手动刷新统计数据
function manualRefreshStats() {
    const runningAccount = document.getElementById('running-account');
    if (runningAccount && runningAccount.textContent && runningAccount.textContent !== '未知') {
        // 显示刷新中状态
        const refreshBtn = document.getElementById('manual-refresh-stats');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 刷新中...';
        
        // 加载最新统计数据
        loadTodayStats(runningAccount.textContent);
        
        // 重置倒计时
        countdownSeconds = 5;
        updateCountdown();
        
        // 恢复按钮状态
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalText;
        }, 1000);
    }
}

// 显示手动刷新按钮
function showManualRefreshButton() {
    const refreshBtn = document.getElementById('manual-refresh-stats');
    if (refreshBtn) {
        refreshBtn.style.display = 'inline-block';
    }
}

// 隐藏手动刷新按钮
function hideManualRefreshButton() {
    const refreshBtn = document.getElementById('manual-refresh-stats');
    if (refreshBtn) {
        refreshBtn.style.display = 'none';
    }
}

// 控制扩展检测参数的启用/禁用状态和展开/收起
function toggleExtensionCheckParams() {
    const doExtensionCheck = document.getElementById('do_extension_check');
    const maxTryInput = document.getElementById('extension_check_max_try');
    const extensionIdInput = document.getElementById('extension_id');
    const extensionDetails = document.getElementById('extension-check-details');
    
    if (doExtensionCheck && maxTryInput && extensionIdInput && extensionDetails) {
        if (doExtensionCheck.checked) {
            // 展开详细配置
            const bsCollapse = new bootstrap.Collapse(extensionDetails, { show: true });
            maxTryInput.disabled = false;
            extensionIdInput.disabled = false;
        } else {
            // 收起详细配置
            const bsCollapse = new bootstrap.Collapse(extensionDetails, { hide: true });
            maxTryInput.disabled = true;
            extensionIdInput.disabled = true;
        }
    }
}

// 控制无头模式标签显示
function toggleHeadlessLabel() {
    const headlessCheckbox = document.getElementById('headless');
    const headlessLabel = document.getElementById('headless-label');
    
    if (headlessCheckbox && headlessLabel) {
        if (headlessCheckbox.checked) {
            headlessLabel.setAttribute('data-i18n', 'config.headless_checked');
            headlessLabel.textContent = getTranslation('config.headless_checked');
        } else {
            headlessLabel.setAttribute('data-i18n', 'config.headless_unchecked');
            headlessLabel.textContent = getTranslation('config.headless_unchecked');
        }
    }
}

// 控制强制运行标签显示
function toggleForceLabel() {
    const forceCheckbox = document.getElementById('force');
    const forceLabel = document.getElementById('force-label');
    
    if (forceCheckbox && forceLabel) {
        if (forceCheckbox.checked) {
            forceLabel.setAttribute('data-i18n', 'config.force_checked');
            forceLabel.textContent = getTranslation('config.force_checked');
        } else {
            forceLabel.setAttribute('data-i18n', 'config.force_unchecked');
            forceLabel.textContent = getTranslation('config.force_unchecked');
        }
    }
}


// 页面加载完成后绑定事件
document.addEventListener('DOMContentLoaded', function() {
    // 绑定扩展检测复选框的change事件
    const doExtensionCheck = document.getElementById('do_extension_check');
    if (doExtensionCheck) {
        doExtensionCheck.addEventListener('change', toggleExtensionCheckParams);
        // 初始化状态
        toggleExtensionCheckParams();
    }
    
    // 绑定无头模式复选框的change事件
    const headlessCheckbox = document.getElementById('headless');
    if (headlessCheckbox) {
        headlessCheckbox.addEventListener('change', toggleHeadlessLabel);
        // 初始化状态
        toggleHeadlessLabel();
    }
    
    // 绑定强制运行复选框的change事件
    const forceCheckbox = document.getElementById('force');
    if (forceCheckbox) {
        forceCheckbox.addEventListener('change', toggleForceLabel);
        // 初始化状态
        toggleForceLabel();
    }
});
</script>
{% endblock %}